<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan & Analytics - SDN Karangsari</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <!-- Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library untuk Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* ==================== LOGO STYLES ==================== */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-school {
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .logo-subtitle {
            font-size: 10px;
            color: #e2e8f0;
            opacity: 0.8;
        }

        /* Header Logo */
        .header-logo {
            display: none;
        }

        /* Role Badge */
        .role-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== FILTER SECTION ==================== */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ==================== TABS NAVIGATION ==================== */
        .tabs-container {
            background: white;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-btn:hover:not(.active) {
            color: #4a5568;
            background: #edf2f7;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== STATS GRID ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-card .subvalue {
            font-size: 14px;
            color: #718096;
        }

        /* ==================== CHART CONTAINERS ==================== */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* ==================== TABLE STYLES ==================== */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .table-header p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 14px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f7fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* ==================== BUTTON STYLES ==================== */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a0aec0, #718096);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover, .btn-success:hover, .btn-warning:hover, .btn-info:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* ==================== EXPORT BUTTONS ==================== */
        .export-buttons-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .export-btn-excel {
            background: linear-gradient(135deg, #21a366, #107c41);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .export-btn-pdf {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .export-btn-excel:hover, .export-btn-pdf:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* ==================== BADGES ==================== */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: #c6f6d5;
            color: #276749;
        }

        .badge-warning {
            background: #feebc8;
            color: #744210;
        }

        .badge-danger {
            background: #fed7d7;
            color: #c53030;
        }

        .badge-info {
            background: #bee3f8;
            color: #2c5aa0;
        }

        .badge-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        /* ==================== LOADING ==================== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ==================== NOTIFICATION STYLES ==================== */
        #custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                flex-direction: column;
            }
            
            .tab-btn {
                text-align: center;
                border-bottom: 1px solid #e2e8f0;
                border-left: 3px solid transparent;
            }
            
            .tab-btn.active {
                border-left-color: #667eea;
                border-bottom-color: #e2e8f0;
            }
            
            .export-buttons-group {
                flex-direction: column;
            }
            
            .export-btn-excel, .export-btn-pdf {
                width: 100%;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-primary, .btn-success, .btn-warning, .btn-info, .btn-secondary {
                width: 100%;
                text-align: center;
            }

            /* Header Logo for Mobile */
            .header-logo {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
            }

            .header-logo-icon {
                width: 32px;
                height: 32px;
                background: linear-gradient(135deg, #667eea, #764ba2);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 14px;
                overflow: hidden;
            }

            .header-logo-fallback {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #667eea, #764ba2);
                color: white;
                font-weight: bold;
                font-size: 12px;
            }

            .header-logo-text {
                display: flex;
                flex-direction: column;
            }

            .header-logo-school {
                font-weight: 700;
                font-size: 14px;
                color: #2d3748;
            }

            .header-logo-subtitle {
                font-size: 9px;
                color: #718096;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="../assets/images/logo.png" alt="Logo SDN Karangsari" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="logo-fallback" style="display: none;">SDN</div>
                </div>
                <div class="logo-text">
                    <div class="logo-school">SDN KARANGSARI</div>
                    <div class="logo-subtitle">MANAJEMEN KELAS</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="manajemen-kelas.html" class="nav-item">
                    <span>üë•</span>
                    <span>Manajemen Kelas</span>
                </a>
                <a href="input-nilai.html" class="nav-item">
                    <span>üìù</span>
                    <span>Input Nilai</span>
                </a>
                <a href="absensi.html" class="nav-item">
                    <span>‚úÖ</span>
                    <span>Absensi</span>
                </a>
                <a href="laporan.html" class="nav-item active">
                    <span>üìã</span>
                    <span>Laporan</span>
                </a>
                <button onclick="logout()" class="nav-item logout">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <!-- Header Logo for Mobile -->
                <div class="header-logo">
                    <div class="header-logo-icon">
                        <img src="../assets/images/logo.png" alt="Logo SDN Karangsari" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="header-logo-fallback" style="display: none;">SDN</div>
                    </div>
                    <div class="header-logo-text">
                        <div class="header-logo-school">SDN KARANGSARI</div>
                        <div class="header-logo-subtitle">MANAJEMEN KELAS</div>
                    </div>
                </div>
                
                <h1>Laporan & Analytics</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <span id="userRole" class="role-badge"></span>
                </div>
            </header>
            
            <div class="dashboard-content">
                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label class="filter-label">Kelas</label>
                            <select id="filterKelas" class="filter-select">
                                <option value="all">Semua Kelas</option>
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Bulan</label>
                            <select id="filterBulan" class="filter-select">
                                <option value="all">Semua Bulan</option>
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Tahun</label>
                            <select id="filterTahun" class="filter-select">
                                <!-- Options akan di-generate otomatis oleh JavaScript -->
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Mata Pelajaran</label>
                            <select id="filterMapel" class="filter-select">
                                <option value="all">Semua Mapel</option>
                                <!-- Options akan di-load via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button onclick="loadLaporan()" class="btn-primary" id="btnLoadLaporan">
                            <span id="btnLoadText">üìä Muat Laporan</span>
                            <span id="btnLoadLoading" class="loading-spinner" style="display: none;"></span>
                        </button>
                        <button onclick="resetFilter()" class="btn-secondary">
                            üîÑ Reset Filter
                        </button>
                    </div>

                    <!-- Export Buttons Group -->
                    <div class="export-buttons-group">
                        <button onclick="exportExcel('presensi')" class="export-btn-excel">
                            üìä Excel Presensi
                        </button>
                        <button onclick="exportExcel('nilai')" class="export-btn-excel">
                            üìä Excel Nilai
                        </button>
                        <button onclick="exportPDF('presensi')" class="export-btn-pdf">
                            üìÑ PDF Presensi
                        </button>
                        <button onclick="exportPDF('nilai')" class="export-btn-pdf">
                            üìÑ PDF Nilai
                        </button>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" onclick="showTab('overview')">üìà Overview</button>
                        <button class="tab-btn" onclick="showTab('presensi')">‚úÖ Rekap Presensi</button>
                        <button class="tab-btn" onclick="showTab('nilai')">üìä Rekap Nilai</button>
                        <button class="tab-btn" onclick="showTab('analytics')">üîç Analytics</button>
                    </div>

                    <!-- Tab: Overview -->
                    <div id="tab-overview" class="tab-content active">
                        <!-- Key Metrics -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Siswa</h3>
                                <div class="value" id="totalSiswa">0</div>
                                <div class="subvalue" id="infoKelas">Semua Kelas</div>
                            </div>
                            <div class="stat-card">
                                <h3>Rata-rata Kehadiran</h3>
                                <div class="value" id="rataKehadiran">0%</div>
                                <div class="subvalue" id="infoBulan">Bulan ini</div>
                            </div>
                            <div class="stat-card">
                                <h3>Rata-rata Nilai</h3>
                                <div class="value" id="rataNilai">0.0</div>
                                <div class="subvalue" id="infoMapel">Semua Mapel</div>
                            </div>
                            <div class="stat-card">
                                <h3>Siswa Perlu Perhatian</h3>
                                <div class="value" id="siswaPerhatian">0</div>
                                <div class="subvalue">Nilai & Presensi rendah</div>
                            </div>
                        </div>

                        <!-- Charts Grid -->
                        <div class="chart-grid">
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Trend Kehadiran Bulanan</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartKehadiran"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Distribusi Nilai</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartDistribusiNilai"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Perbandingan Kelas</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartPerbandinganKelas"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Top Performers</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartTopPerformers"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Rekap Presensi -->
                    <div id="tab-presensi" class="tab-content">
                        <div class="table-container">
                            <div class="table-header">
                                <div>
                                    <h3>Rekap Presensi Siswa</h3>
                                    <p id="presensiDescription">Data kehadiran berdasarkan filter yang dipilih</p>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Hadir</th>
                                            <th>Izin</th>
                                            <th>Sakit</th>
                                            <th>Alpha</th>
                                            <th>Total</th>
                                            <th>Persentase</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="presensiTableBody">
                                        <tr>
                                            <td colspan="10">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">‚úÖ</div>
                                                    <p>Belum ada data presensi</p>
                                                    <small>Pilih filter dan klik "Muat Laporan"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Rekap Nilai -->
                    <div id="tab-nilai" class="tab-content">
                        <div class="table-container">
                            <div class="table-header">
                                <div>
                                    <h3>Rekap Nilai Akademik</h3>
                                    <p id="nilaiDescription">Data nilai berdasarkan filter yang dipilih</p>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>No</th>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Matematika</th>
                                            <th>B Indonesia</th>
                                            <th>IPAS</th>
                                            <th>PKn</th>
                                            <th>Bahasa Jawa</th>
                                            <th>SBDP</th>
                                            <th>PJOK</th>
                                            <th>PAI</th>
                                            <th>Rata-rata</th>
                                            <th>Ranking</th>
                                        </tr>
                                    </thead>
                                    <tbody id="nilaiTableBody">
                                        <tr>
                                            <td colspan="13">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">üìä</div>
                                                    <p>Belum ada data nilai</p>
                                                    <small>Pilih filter dan klik "Muat Laporan"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Analytics -->
                    <div id="tab-analytics" class="tab-content">
                        <div class="chart-grid">
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Korelasi Kehadiran & Nilai</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartKorelasi"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h3>Trend Perkembangan</h3>
                                </div>
                                <div class="chart-wrapper">
                                    <canvas id="chartTrend"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3>Analisis Siswa Perlu Perhatian</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Nama Siswa</th>
                                            <th>Kelas</th>
                                            <th>Kehadiran</th>
                                            <th>Rata-rata Nilai</th>
                                            <th>Area Improvement</th>
                                            <th>Rekomendasi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsTableBody">
                                        <tr>
                                            <td colspan="6">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">üîç</div>
                                                    <p>Belum ada data analisis</p>
                                                    <small>Pilih filter dan klik "Muat Laporan"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Laporan & Analytics Functions
        let currentUser = null;
        let currentCharts = {};
        let currentData = {
            absensi: [],
            nilai: [],
            siswa: [],
            analytics: []
        };

        // Chart colors
        const CHART_COLORS = {
            primary: '#667eea',
            success: '#48bb78',
            warning: '#ed8936',
            danger: '#f56565',
            info: '#4299e1',
            secondary: '#a0aec0'
        };

        // Informasi mata pelajaran dengan pembatasan kelas
        const MATA_PELAJARAN_INFO = {
            'M1': { nama: 'Matematika', kelas: '1,2,3,4,5,6' },
            'M2': { nama: 'Bahasa Indonesia', kelas: '1,2,3,4,5,6' },
            'M3': { nama: 'Bahasa Jawa', kelas: '1,2,3,4,5,6' },
            'M4': { nama: 'PKn', kelas: '1,2,3,4,5,6' },
            'M5': { nama: 'SBDP', kelas: '1,2,3,4,5,6' },
            'M6': { nama: 'PAI', kelas: '1,2,3,4,5,6' },
            'M7': { nama: 'PJOK', kelas: '1,2,3,4,5,6' },
            'M8': { nama: 'IPAS', kelas: '3,4,5,6' }, // Hanya untuk kelas 3-6
            'MTK': { nama: 'Matematika', kelas: '1,2,3,4,5,6' },
            'BINDO': { nama: 'Bahasa Indonesia', kelas: '1,2,3,4,5,6' },
            'BJAWA': { nama: 'Bahasa Jawa', kelas: '1,2,3,4,5,6' },
            'PKN': { nama: 'PKn', kelas: '1,2,3,4,5,6' },
            'SBDP': { nama: 'SBDP', kelas: '1,2,3,4,5,6' },
            'PAI': { nama: 'PAI', kelas: '1,2,3,4,5,6' },
            'PJOK': { nama: 'PJOK', kelas: '1,2,3,4,5,6' },
            'IPAS': { nama: 'IPAS', kelas: '3,4,5,6' }, // Hanya untuk kelas 3-6
            'IPA': { nama: 'IPAS', kelas: '3,4,5,6' }, // Mapping untuk nilai lama IPA -> IPAS
            'IPS': { nama: 'IPAS', kelas: '3,4,5,6' }  // Mapping untuk nilai lama IPS -> IPAS
        };

        // ==================== UTILITY FUNCTIONS ====================

        // Fungsi untuk generate tahun otomatis (5 tahun terakhir + 5 tahun ke depan)
        function generateTahunOptions() {
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 5;
            const endYear = currentYear + 5;
            
            const tahunSelect = document.getElementById('filterTahun');
            tahunSelect.innerHTML = '';
            
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                tahunSelect.appendChild(option);
            }
            
            console.log('üìÖ Tahun options generated:', startYear, 'to', endYear);
        }

        // Fungsi untuk format tanggal yang konsisten
        function formatTanggal(tanggal) {
            const date = new Date(tanggal);
            const tahun = date.getFullYear();
            const bulan = String(date.getMonth() + 1).padStart(2, '0');
            const hari = String(date.getDate()).padStart(2, '0');
            return `${tahun}-${bulan}-${hari}`;
        }

        // Fungsi untuk mendapatkan hari terakhir bulan
        function getLastDayOfMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // Fungsi untuk mendapatkan nama bulan
        function getNamaBulan(bulan) {
            const bulanNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return bulanNames[parseInt(bulan) - 1] || '';
        }

        // Fungsi untuk status kehadiran
        function getStatusKehadiran(persentase) {
            if (persentase >= 90) return { class: 'badge-success', text: 'Sangat Baik' };
            if (persentase >= 80) return { class: 'badge-info', text: 'Baik' };
            if (persentase >= 70) return { class: 'badge-warning', text: 'Cukup' };
            return { class: 'badge-danger', text: 'Perlu Perhatian' };
        }

        // Fungsi utility untuk timestamp export
        function getExportTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}${month}${day}_${hours}${minutes}`;
        }

        // Fungsi untuk mendapatkan nama mapel
        function getNamaMapel(mapelId) {
            return MATA_PELAJARAN_INFO[mapelId] ? MATA_PELAJARAN_INFO[mapelId].nama : mapelId;
        }

        // ==================== MAIN FUNCTIONS ====================

        async function loadLaporanPage() {
            console.log('üìä Loading laporan system...');
            
            currentUser = checkAuth();
            if (!currentUser) {
                console.log('‚ùå User not authenticated, redirecting...');
                window.location.href = '../index.html';
                return;
            }
            
            console.log('‚úÖ User authenticated:', currentUser);
            
            // Display user info
            document.getElementById('userName').textContent = currentUser.nama;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Generate tahun options otomatis
            generateTahunOptions();
            
            // Setup filter berdasarkan role
            setupFilterByRole();
            
            // Load mata pelajaran
            loadMataPelajaran();
            
            // Set default bulan ke bulan saat ini
            const now = new Date();
            document.getElementById('filterBulan').value = now.getMonth() + 1;
            
            // Auto-load data
            setTimeout(() => {
                loadLaporan();
            }, 1000);
        }

        function setupFilterByRole() {
            const filterKelas = document.getElementById('filterKelas');
            
            if (currentUser.role === 'Guru Kelas' && currentUser.kelas_dipegang) {
                const kelasAngka = currentUser.kelas_dipegang.replace('A', '');
                filterKelas.value = kelasAngka;
                filterKelas.disabled = true;
                filterKelas.style.backgroundColor = '#f7fafc';
                console.log('üéØ Guru kelas - auto select class:', kelasAngka);
            }
        }

        // Fungsi load mata pelajaran
        function loadMataPelajaran() {
            const kelas = document.getElementById('filterKelas').value;
            const mataPelajaran = [
                { nama: 'Matematika', kode: 'MTK', kelas: '1,2,3,4,5,6' },
                { nama: 'Bahasa Indonesia', kode: 'BINDO', kelas: '1,2,3,4,5,6' },
                { nama: 'IPAS', kode: 'IPAS', kelas: '3,4,5,6' }, // IPAS hanya untuk kelas 3-6
                { nama: 'PKn', kode: 'PKN', kelas: '1,2,3,4,5,6' },
                { nama: 'Bahasa Jawa', kode: 'BJAWA', kelas: '1,2,3,4,5,6' },
                { nama: 'SBDP', kode: 'SBDP', kelas: '1,2,3,4,5,6' },
                { nama: 'PJOK', kode: 'PJOK', kelas: '1,2,3,4,5,6' },
                { nama: 'PAI', kode: 'PAI', kelas: '1,2,3,4,5,6' }
            ];
            
            // Filter mata pelajaran berdasarkan kelas
            const filteredMapel = mataPelajaran.filter(mapel => {
                if (kelas === 'all') return true;
                
                const kelasNum = parseInt(kelas);
                const availableKelas = mapel.kelas.split(',').map(k => parseInt(k));
                return availableKelas.includes(kelasNum);
            });
            
            const selectMapel = document.getElementById('filterMapel');
            selectMapel.innerHTML = '<option value="all">Semua Mapel</option>' +
                filteredMapel.map(mapel => 
                    `<option value="${mapel.nama}">${mapel.nama}</option>`
                ).join('');
        }

        function showTab(tabName) {
            console.log('üîÑ Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate clicked button
            event.target.classList.add('active');
            
            // Load data for the selected tab
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            console.log('üìä Loading data for tab:', tabName);
            
            switch(tabName) {
                case 'overview':
                    initializeOverviewCharts();
                    break;
                case 'presensi':
                    loadPresensiData();
                    break;
                case 'nilai':
                    loadNilaiData();
                    break;
                case 'analytics':
                    initializeAnalyticsCharts();
                    break;
            }
        }

        async function loadLaporan() {
            const kelas = document.getElementById('filterKelas').value;
            const bulan = document.getElementById('filterBulan').value;
            const tahun = document.getElementById('filterTahun').value;
            const mapel = document.getElementById('filterMapel').value;
            
            // Show loading
            const btnLoad = document.getElementById('btnLoadLaporan');
            const btnLoadText = document.getElementById('btnLoadText');
            const btnLoadLoading = document.getElementById('btnLoadLoading');
            
            btnLoad.disabled = true;
            btnLoadText.style.display = 'none';
            btnLoadLoading.style.display = 'inline-block';
            
            try {
                console.log('üìä Loading laporan...', { kelas, bulan, tahun, mapel });
                
                // Load all data
                await Promise.all([
                    loadDataAbsensi(kelas, bulan, tahun),
                    loadDataNilai(kelas, mapel, tahun),
                    loadDataSiswa(kelas),
                    loadDataAnalytics(kelas, bulan, tahun, mapel)
                ]);
                
                // Update UI
                updateOverview();
                updatePresensiTab();
                updateNilaiTab();
                updateAnalyticsTab();
                
                // Initialize charts
                initializeCharts();
                
                showNotification('‚úÖ Laporan berhasil dimuat', 'success', 2000);
                
            } catch (error) {
                console.error('‚ùå Error loading laporan:', error);
                showNotification('Gagal memuat laporan: ' + error.message, 'error', 4000);
            } finally {
                // Hide loading
                btnLoad.disabled = false;
                btnLoadText.style.display = 'inline-block';
                btnLoadLoading.style.display = 'none';
            }
        }

        // ==================== DATA LOADING FUNCTIONS ====================

        async function loadDataAbsensi(kelas, bulan, tahun) {
            try {
                console.log('üìä Loading absensi data...', { kelas, bulan, tahun });
                
                let query = supabase.from('absensi').select('*');
                
                if (kelas !== 'all') {
                    query = query.eq('kelas', kelas);
                }
                
                if (bulan !== 'all') {
                    const startDate = `${tahun}-${bulan.padStart(2, '0')}-01`;
                    const lastDay = getLastDayOfMonth(parseInt(tahun), parseInt(bulan));
                    const endDate = `${tahun}-${bulan.padStart(2, '0')}-${lastDay}`;
                    query = query.gte('tanggal', startDate).lte('tanggal', endDate);
                } else {
                    query = query.like('tanggal', `${tahun}-%`);
                }
                
                const { data: absensi, error } = await query;
                
                if (error) throw error;
                
                // Format tanggal untuk konsistensi
                currentData.absensi = (absensi || []).map(item => ({
                    ...item,
                    tanggal: formatTanggal(item.tanggal)
                }));
                
                console.log('‚úÖ Absensi data loaded:', currentData.absensi.length, 'records');
                
            } catch (error) {
                console.error('‚ùå Error loading absensi:', error);
                currentData.absensi = [];
                showNotification('Gagal memuat data absensi: ' + error.message, 'error', 4000);
            }
        }

        async function loadDataNilai(kelas, mapel, tahun) {
            try {
                console.log('üìä Loading nilai data...', { kelas, mapel, tahun });
                
                let query = supabase.from('nilai').select('*');
                
                if (kelas !== 'all') {
                    query = query.eq('kelas', kelas);
                }
                
                if (mapel !== 'all') {
                    // Convert mapel name to mapel_id
                    const mapelId = Object.keys(MATA_PELAJARAN_INFO).find(key => 
                        MATA_PELAJARAN_INFO[key].nama === mapel
                    );
                    if (mapelId) {
                        query = query.eq('mapel_id', mapelId);
                    }
                }
                
                const { data: nilai, error } = await query;
                
                if (error) throw error;
                
                // Filter IPAS untuk kelas 1-2
                currentData.nilai = (nilai || []).filter(item => {
                    const kelasNum = parseInt(item.kelas);
                    const isIPASMapel = item.mapel_id === 'M8' || 
                                       item.mapel_id === 'IPAS' || 
                                       item.mapel_id === 'IPA' || 
                                       item.mapel_id === 'IPS';
                    
                    // Jika kelas 1-2 dan mapel IPAS, exclude
                    if (kelasNum >= 1 && kelasNum <= 2 && isIPASMapel) {
                        return false;
                    }
                    return true;
                });
                
                console.log('‚úÖ Nilai data loaded:', currentData.nilai.length, 'records');
                
            } catch (error) {
                console.error('‚ùå Error loading nilai:', error);
                currentData.nilai = [];
                showNotification('Gagal memuat data nilai: ' + error.message, 'error', 4000);
            }
        }

        async function loadDataSiswa(kelas) {
            try {
                let query = supabase.from('siswa').select('*').eq('status', true);
                
                if (kelas !== 'all') {
                    query = query.eq('kelas', kelas);
                }
                
                const { data: siswa, error } = await query;
                
                if (error) throw error;
                
                currentData.siswa = siswa || [];
                console.log('‚úÖ Siswa data loaded:', currentData.siswa.length);
                
            } catch (error) {
                console.error('‚ùå Error loading siswa:', error);
                currentData.siswa = [];
            }
        }

        async function loadDataAnalytics(kelas, bulan, tahun, mapel) {
            try {
                console.log('üîç Loading analytics data...');
                currentData.analytics = generateAnalyticsData();
                console.log('‚úÖ Analytics data loaded:', currentData.analytics.length, 'students need attention');
                
            } catch (error) {
                console.error('‚ùå Error loading analytics:', error);
                currentData.analytics = [];
            }
        }

        // ==================== DATA CALCULATION FUNCTIONS ====================

        // PERBAIKAN BESAR: Fungsi menghitung rekap absensi yang benar
        function calculateAbsensiRekap() {
            const rekap = {};
            
            console.log('üìä Calculating absensi rekap...');
            console.log('Total siswa:', currentData.siswa.length);
            console.log('Total data absensi:', currentData.absensi.length);
            
            // Inisialisasi semua siswa terlebih dahulu
            currentData.siswa.forEach(siswa => {
                rekap[siswa.id_siswa] = {
                    nama: siswa.nama_siswa,
                    kelas: siswa.kelas,
                    hadir: 0,
                    izin: 0,
                    sakit: 0,
                    alpha: 0,
                    total: 0
                };
            });
            
            // Hitung absensi dari data absensi
            currentData.absensi.forEach(absensi => {
                if (rekap[absensi.siswa_id]) {
                    const status = absensi.status ? absensi.status.toLowerCase() : 'alpha';
                    if (status === 'h') {
                        rekap[absensi.siswa_id].hadir++;
                    } else if (status === 'i') {
                        rekap[absensi.siswa_id].izin++;
                    } else if (status === 's') {
                        rekap[absensi.siswa_id].sakit++;
                    } else {
                        rekap[absensi.siswa_id].alpha++;
                    }
                    rekap[absensi.siswa_id].total++;
                }
            });
            
            const result = Object.values(rekap);
            console.log('‚úÖ Absensi rekap calculated:', result.length, 'students');
            return result;
        }

        // PERBAIKAN: Fungsi menghitung rekap nilai dengan struktur yang benar
        function calculateNilaiRekap() {
            const rekap = {};
            
            // Inisialisasi semua siswa terlebih dahulu
            currentData.siswa.forEach(siswa => {
                const kelasNum = parseInt(siswa.kelas);
                rekap[siswa.id_siswa] = {
                    nama: siswa.nama_siswa,
                    kelas: siswa.kelas,
                    matematika: null,
                    bindo: null,
                    ipas: kelasNum >= 3 ? null : undefined, // IPAS hanya untuk kelas 3-6
                    pkn: null,
                    bjawa: null,
                    sbdp: null,
                    pjok: null,
                    pai: null,
                    totalNilai: 0,
                    totalMapel: 0,
                    rataRata: 0
                };
            });
            
            // Process nilai data
            currentData.nilai.forEach(nilai => {
                const siswaId = nilai.siswa_id;
                const kelasNum = parseInt(nilai.kelas);
                
                if (!rekap[siswaId]) return;
                
                const mapelName = getNamaMapel(nilai.mapel_id);
                const nilaiNum = parseFloat(nilai.nilai);
                
                if (isNaN(nilaiNum)) return;
                
                // Mapping nilai ke kolom yang sesuai
                switch(mapelName) {
                    case 'Matematika':
                        rekap[siswaId].matematika = nilaiNum;
                        break;
                    case 'Bahasa Indonesia':
                        rekap[siswaId].bindo = nilaiNum;
                        break;
                    case 'IPAS':
                        if (kelasNum >= 3) {
                            rekap[siswaId].ipas = nilaiNum;
                        }
                        break;
                    case 'PKn':
                        rekap[siswaId].pkn = nilaiNum;
                        break;
                    case 'Bahasa Jawa':
                        rekap[siswaId].bjawa = nilaiNum;
                        break;
                    case 'SBDP':
                        rekap[siswaId].sbdp = nilaiNum;
                        break;
                    case 'PJOK':
                        rekap[siswaId].pjok = nilaiNum;
                        break;
                    case 'PAI':
                        rekap[siswaId].pai = nilaiNum;
                        break;
                }
                
                // Hitung total untuk rata-rata (exclude IPAS untuk kelas 1-2)
                if (!(mapelName === 'IPAS' && kelasNum <= 2)) {
                    rekap[siswaId].totalNilai += nilaiNum;
                    rekap[siswaId].totalMapel++;
                }
            });
            
            // Calculate averages
            Object.values(rekap).forEach(siswa => {
                if (siswa.totalMapel > 0) {
                    siswa.rataRata = parseFloat((siswa.totalNilai / siswa.totalMapel).toFixed(1));
                }
            });
            
            return Object.values(rekap);
        }

        function generateAnalyticsData() {
            const siswaPerhatian = [];
            
            const nilaiRekap = calculateNilaiRekap();
            const absensiRekap = calculateAbsensiRekap();
            
            // Gabungkan data absensi dan nilai
            const combinedData = nilaiRekap.map(nilai => {
                const absensi = absensiRekap.find(p => p.nama === nilai.nama && p.kelas === nilai.kelas);
                return {
                    ...nilai,
                    kehadiran: absensi ? (absensi.total > 0 ? Math.round((absensi.hadir / absensi.total) * 100) : 0) : 0
                };
            });
            
            combinedData.forEach(siswa => {
                if (siswa.kehadiran < 80 || siswa.rataRata < 70) {
                    const areaImprovement = [];
                    
                    if (siswa.kehadiran < 80) areaImprovement.push('Kehadiran');
                    if (siswa.rataRata < 70) areaImprovement.push('Nilai Akademik');
                    
                    // Analisis mata pelajaran spesifik
                    if (siswa.matematika && siswa.matematika < 70) areaImprovement.push('Matematika');
                    if (siswa.bindo && siswa.bindo < 70) areaImprovement.push('Bahasa Indonesia');
                    if (siswa.ipas && siswa.ipas < 70) areaImprovement.push('IPAS');
                    
                    siswaPerhatian.push({
                        nama: siswa.nama,
                        kelas: siswa.kelas,
                        kehadiran: siswa.kehadiran,
                        rataNilai: siswa.rataRata,
                        areaImprovement: areaImprovement,
                        rekomendasi: generateRekomendasi(siswa.kehadiran, siswa.rataRata, areaImprovement)
                    });
                }
            });
            
            return siswaPerhatian;
        }

        function generateRekomendasi(kehadiran, rataNilai, areaImprovement) {
            const rekomendasi = [];
            
            if (kehadiran < 80) {
                rekomendasi.push(kehadiran < 60 ? 
                    'Perlu pertemuan dengan orang tua/wali' : 
                    'Tingkatkan frekuensi kehadiran');
            }
            
            if (rataNilai < 70) {
                rekomendasi.push(rataNilai < 60 ? 
                    'Bimbingan belajar intensif diperlukan' : 
                    'Perlu tambahan jam belajar');
            }
            
            if (areaImprovement.includes('Matematika')) {
                rekomendasi.push('Latihan soal matematika harian');
            }
            
            if (areaImprovement.includes('Bahasa Indonesia')) {
                rekomendasi.push('Perbanyak membaca dan menulis');
            }
            
            return rekomendasi.length > 0 ? rekomendasi.join(', ') : 'Pertahankan performa yang baik';
        }

        function calculateRataKehadiran() {
            const absensiRekap = calculateAbsensiRekap();
            if (absensiRekap.length === 0) return 0;
            
            const totalHadir = absensiRekap.reduce((sum, siswa) => sum + siswa.hadir, 0);
            const totalRecords = absensiRekap.reduce((sum, siswa) => sum + siswa.total, 0);
            
            return totalRecords > 0 ? Math.round((totalHadir / totalRecords) * 100) : 0;
        }

        function calculateRataNilai() {
            const nilaiRekap = calculateNilaiRekap();
            if (nilaiRekap.length === 0) return 0;
            
            const totalRata = nilaiRekap.reduce((sum, siswa) => sum + siswa.rataRata, 0);
            return parseFloat((totalRata / nilaiRekap.length).toFixed(1));
        }

        // ==================== EXPORT FUNCTIONS ====================

        async function exportExcel(tipe) {
            try {
                console.log(`üìä Exporting ${tipe} to Excel...`);
                
                showNotification(`‚è≥ Menyiapkan data ${tipe} untuk export Excel...`, 'info', 2000);
                
                let data, fileName, headers, worksheetName;
                
                if (tipe === 'presensi') {
                    data = calculateAbsensiRekap();
                    fileName = `Laporan_Absensi_${getExportTimestamp()}.xlsx`;
                    headers = ['No', 'Nama Siswa', 'Kelas', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase', 'Status'];
                    worksheetName = 'Data Absensi';
                } else if (tipe === 'nilai') {
                    data = calculateNilaiRekap();
                    data.sort((a, b) => b.rataRata - a.rataRata);
                    fileName = `Laporan_Nilai_${getExportTimestamp()}.xlsx`;
                    headers = ['Ranking', 'Nama Siswa', 'Kelas', 'Matematika', 'B Indonesia', 'IPAS', 'PKn', 'Bahasa Jawa', 'SBDP', 'PJOK', 'PAI', 'Rata-rata'];
                    worksheetName = 'Data Nilai';
                } else {
                    throw new Error('Tipe export tidak valid');
                }
                
                if (data.length === 0) {
                    showNotification('‚ùå Tidak ada data untuk diexport', 'error', 3000);
                    return;
                }
                
                // Prepare data for Excel
                const excelData = data.map((item, index) => {
                    if (tipe === 'presensi') {
                        const persentase = item.total > 0 ? Math.round((item.hadir / item.total) * 100) : 0;
                        const status = getStatusKehadiran(persentase).text;
                        
                        return [
                            index + 1,
                            item.nama,
                            `Kelas ${item.kelas}`,
                            item.hadir,
                            item.izin,
                            item.sakit,
                            item.alpha,
                            item.total,
                            `${persentase}%`,
                            status
                        ];
                    } else {
                        const kelasNum = parseInt(item.kelas);
                        return [
                            index + 1,
                            item.nama,
                            `Kelas ${item.kelas}`,
                            item.matematika || '-',
                            item.bindo || '-',
                            kelasNum >= 3 ? (item.ipas || '-') : '-',
                            item.pkn || '-',
                            item.bjawa || '-',
                            item.sbdp || '-',
                            item.pjok || '-',
                            item.pai || '-',
                            item.rataRata.toFixed(1)
                        ];
                    }
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const excelDataWithHeaders = [headers, ...excelData];
                const ws = XLSX.utils.aoa_to_sheet(excelDataWithHeaders);
                
                // Style the header row
                if (!ws['!cols']) ws['!cols'] = [];
                headers.forEach((_, index) => {
                    ws['!cols'][index] = { width: 15 };
                });
                
                XLSX.utils.book_append_sheet(wb, ws, worksheetName);
                XLSX.writeFile(wb, fileName);
                
                showNotification(`‚úÖ ${tipe} berhasil diexport ke Excel`, 'success', 3000);
                
            } catch (error) {
                console.error('‚ùå Error exporting to Excel:', error);
                showNotification('Gagal export Excel: ' + error.message, 'error', 4000);
            }
        }

        async function exportPDF(tipe) {
            try {
                console.log(`üìÑ Exporting ${tipe} to PDF...`);
                
                showNotification(`‚è≥ Menyiapkan data ${tipe} untuk export PDF...`, 'info', 2000);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Get filter info for header
                const kelas = document.getElementById('filterKelas').value;
                const bulan = document.getElementById('filterBulan').value;
                const tahun = document.getElementById('filterTahun').value;
                const mapel = document.getElementById('filterMapel').value;
                
                const filterInfo = `Kelas: ${kelas === 'all' ? 'Semua' : kelas} | Bulan: ${bulan === 'all' ? 'Semua' : getNamaBulan(bulan)} | Tahun: ${tahun} | Mapel: ${mapel === 'all' ? 'Semua' : mapel}`;
                
                if (tipe === 'presensi') {
                    await exportAbsensiPDF(doc, filterInfo);
                } else if (tipe === 'nilai') {
                    await exportNilaiPDF(doc, filterInfo);
                } else {
                    throw new Error('Tipe export tidak valid');
                }
                
                doc.save(`Laporan_${tipe}_${getExportTimestamp()}.pdf`);
                showNotification(`‚úÖ ${tipe} berhasil diexport ke PDF`, 'success', 3000);
                
            } catch (error) {
                console.error('‚ùå Error exporting to PDF:', error);
                showNotification('Gagal export PDF: ' + error.message, 'error', 4000);
            }
        }

        async function exportAbsensiPDF(doc, filterInfo) {
            const absensiData = calculateAbsensiRekap();
            
            if (absensiData.length === 0) {
                doc.setFontSize(16);
                doc.text('TIDAK ADA DATA ABSENSI', 105, 100, { align: 'center' });
                return;
            }
            
            // Add header
            doc.setFontSize(16);
            doc.setTextColor(40, 40, 40);
            doc.text('LAPORAN ABSENSI SISWA', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(filterInfo, 105, 22, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text(`Generated on: ${new Date().toLocaleString('id-ID')}`, 105, 28, { align: 'center' });
            
            // Prepare table data
            const tableData = absensiData.map((siswa, index) => {
                const persentase = siswa.total > 0 ? Math.round((siswa.hadir / siswa.total) * 100) : 0;
                const status = getStatusKehadiran(persentase).text;
                
                return [
                    (index + 1).toString(),
                    siswa.nama,
                    `Kelas ${siswa.kelas}`,
                    siswa.hadir.toString(),
                    siswa.izin.toString(),
                    siswa.sakit.toString(),
                    siswa.alpha.toString(),
                    siswa.total.toString(),
                    `${persentase}%`,
                    status
                ];
            });
            
            // Add table
            doc.autoTable({
                startY: 35,
                head: [['No', 'Nama Siswa', 'Kelas', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Total', 'Persentase', 'Status']],
                body: tableData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [72, 187, 120], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                columnStyles: {
                    0: { cellWidth: 10 }, 1: { cellWidth: 30 }, 2: { cellWidth: 15 },
                    3: { cellWidth: 10 }, 4: { cellWidth: 10 }, 5: { cellWidth: 10 },
                    6: { cellWidth: 10 }, 7: { cellWidth: 10 }, 8: { cellWidth: 15 },
                    9: { cellWidth: 20 }
                },
                margin: { top: 35 }
            });
        }

        async function exportNilaiPDF(doc, filterInfo) {
            const nilaiData = calculateNilaiRekap();
            
            if (nilaiData.length === 0) {
                doc.setFontSize(16);
                doc.text('TIDAK ADA DATA NILAI', 105, 100, { align: 'center' });
                return;
            }
            
            // Sort by average
            nilaiData.sort((a, b) => b.rataRata - a.rataRata);
            
            // Add header
            doc.setFontSize(16);
            doc.setTextColor(40, 40, 40);
            doc.text('LAPORAN NILAI SISWA', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(filterInfo, 105, 22, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text(`Generated on: ${new Date().toLocaleString('id-ID')}`, 105, 28, { align: 'center' });
            
            // Prepare table data
            const tableData = nilaiData.map((siswa, index) => {
                const kelasNum = parseInt(siswa.kelas);
                return [
                    (index + 1).toString(),
                    siswa.nama,
                    `Kelas ${siswa.kelas}`,
                    siswa.matematika ? siswa.matematika.toString() : '-',
                    siswa.bindo ? siswa.bindo.toString() : '-',
                    kelasNum >= 3 ? (siswa.ipas ? siswa.ipas.toString() : '-') : '-',
                    siswa.pkn ? siswa.pkn.toString() : '-',
                    siswa.bjawa ? siswa.bjawa.toString() : '-',
                    siswa.sbdp ? siswa.sbdp.toString() : '-',
                    siswa.pjok ? siswa.pjok.toString() : '-',
                    siswa.pai ? siswa.pai.toString() : '-',
                    siswa.rataRata.toFixed(1)
                ];
            });
            
            // Add table
            doc.autoTable({
                startY: 35,
                head: [['Ranking', 'Nama Siswa', 'Kelas', 'Matematika', 'B Indonesia', 'IPAS', 'PKn', 'Bahasa Jawa', 'SBDP', 'PJOK', 'PAI', 'Rata-rata']],
                body: tableData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [237, 137, 54], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                columnStyles: {
                    0: { cellWidth: 12 }, 1: { cellWidth: 25 }, 2: { cellWidth: 12 },
                    3: { cellWidth: 12 }, 4: { cellWidth: 12 }, 5: { cellWidth: 12 },
                    6: { cellWidth: 12 }, 7: { cellWidth: 12 }, 8: { cellWidth: 12 },
                    9: { cellWidth: 12 }, 10: { cellWidth: 12 }, 11: { cellWidth: 12 }
                },
                margin: { top: 35 }
            });
        }

        // ==================== UI UPDATE FUNCTIONS ====================

        function updateOverview() {
            const totalSiswa = currentData.siswa.length;
            const rataKehadiran = calculateRataKehadiran();
            const rataNilai = calculateRataNilai();
            const siswaPerhatian = currentData.analytics.length;
            
            document.getElementById('totalSiswa').textContent = totalSiswa;
            document.getElementById('rataKehadiran').textContent = `${rataKehadiran}%`;
            document.getElementById('rataNilai').textContent = rataNilai.toFixed(1);
            document.getElementById('siswaPerhatian').textContent = siswaPerhatian;
            
            // Update info texts
            const kelas = document.getElementById('filterKelas').value;
            const bulan = document.getElementById('filterBulan').value;
            const mapel = document.getElementById('filterMapel').value;
            
            document.getElementById('infoKelas').textContent = kelas === 'all' ? 'Semua Kelas' : `Kelas ${kelas}`;
            document.getElementById('infoBulan').textContent = bulan === 'all' ? 'Tahun ini' : `Bulan ${getNamaBulan(bulan)}`;
            document.getElementById('infoMapel').textContent = mapel === 'all' ? 'Semua Mapel' : mapel;
        }

        // PERBAIKAN: Update presensi tab dengan data absensi yang benar
        function updatePresensiTab() {
            const tbody = document.getElementById('presensiTableBody');
            const absensiRekap = calculateAbsensiRekap();
            
            console.log('üìä Updating presensi tab with data:', absensiRekap);
            
            if (absensiRekap.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚úÖ</div>
                                <p>Tidak ada data absensi</p>
                                <small>Data tidak ditemukan untuk filter yang dipilih</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = absensiRekap.map((siswa, index) => {
                const persentase = siswa.total > 0 ? Math.round((siswa.hadir / siswa.total) * 100) : 0;
                const status = getStatusKehadiran(persentase);
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${siswa.nama}</strong></td>
                        <td>Kelas ${siswa.kelas}</td>
                        <td>${siswa.hadir}</td>
                        <td>${siswa.izin}</td>
                        <td>${siswa.sakit}</td>
                        <td>${siswa.alpha}</td>
                        <td>${siswa.total}</td>
                        <td><strong>${persentase}%</strong></td>
                        <td><span class="badge ${status.class}">${status.text}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Update description
            const kelas = document.getElementById('filterKelas').value;
            const bulan = document.getElementById('filterBulan').value;
            document.getElementById('presensiDescription').textContent = 
                `Rekap absensi ${kelas === 'all' ? 'semua kelas' : `Kelas ${kelas}`} 
                 untuk ${bulan === 'all' ? 'tahun ini' : `bulan ${getNamaBulan(bulan)}`}`;
        }

        // PERBAIKAN BESAR: Update nilai tab dengan struktur yang benar - hilangkan kolom IPAS untuk kelas 1-2
        function updateNilaiTab() {
            const tbody = document.getElementById('nilaiTableBody');
            const nilaiRekap = calculateNilaiRekap();
            
            if (nilaiRekap.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìä</div>
                                <p>Tidak ada data nilai</p>
                                <small>Data tidak ditemukan untuk filter yang dipilih</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by average and add ranking
            nilaiRekap.sort((a, b) => b.rataRata - a.rataRata);
            
            tbody.innerHTML = nilaiRekap.map((siswa, index) => {
                const ranking = index + 1;
                const rankingClass = ranking <= 3 ? 'badge-success' : 
                                   ranking <= 10 ? 'badge-info' : 'badge-secondary';
                const kelasNum = parseInt(siswa.kelas);
                
                // PERBAIKAN: Hilangkan kolom IPAS untuk kelas 1-2
                const ipasCell = kelasNum >= 3 ? (siswa.ipas || '-') : '-';
                
                return `
                    <tr>
                        <td>${ranking}</td>
                        <td><strong>${siswa.nama}</strong></td>
                        <td>Kelas ${siswa.kelas}</td>
                        <td>${siswa.matematika || '-'}</td>
                        <td>${siswa.bindo || '-'}</td>
                        <td>${ipasCell}</td>
                        <td>${siswa.pkn || '-'}</td>
                        <td>${siswa.bjawa || '-'}</td>
                        <td>${siswa.sbdp || '-'}</td>
                        <td>${siswa.pjok || '-'}</td>
                        <td>${siswa.pai || '-'}</td>
                        <td><strong>${siswa.rataRata.toFixed(1)}</strong></td>
                        <td><span class="badge ${rankingClass}">#${ranking}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Update description
            const kelas = document.getElementById('filterKelas').value;
            const mapel = document.getElementById('filterMapel').value;
            document.getElementById('nilaiDescription').textContent = 
                `Rekap nilai ${mapel === 'all' ? 'semua mata pelajaran' : mapel} 
                 untuk ${kelas === 'all' ? 'semua kelas' : `Kelas ${kelas}`}`;
        }

        function updateAnalyticsTab() {
            const tbody = document.getElementById('analyticsTableBody');
            const analyticsData = currentData.analytics;
            
            if (analyticsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üéâ</div>
                                <p>Tidak ada siswa yang perlu perhatian khusus</p>
                                <small>Semua siswa menunjukkan performa yang baik</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = analyticsData.map(siswa => {
                return `
                    <tr>
                        <td><strong>${siswa.nama}</strong></td>
                        <td>Kelas ${siswa.kelas}</td>
                        <td>${siswa.kehadiran}%</td>
                        <td>${siswa.rataNilai.toFixed(1)}</td>
                        <td>${siswa.areaImprovement.join(', ')}</td>
                        <td>${siswa.rekomendasi}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== CHART FUNCTIONS ====================

        function initializeCharts() {
            // Destroy existing charts
            Object.values(currentCharts).forEach(tabCharts => {
                Object.values(tabCharts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
            });
            
            currentCharts = {
                overview: {},
                analytics: {}
            };
            
            // Initialize overview charts
            initializeOverviewCharts();
            
            // Initialize analytics charts
            initializeAnalyticsCharts();
        }

        function initializeOverviewCharts() {
            console.log('üìà Initializing overview charts...');
            
            // Chart 1: Trend Kehadiran
            const ctx1 = document.getElementById('chartKehadiran');
            if (ctx1) {
                currentCharts.overview.kehadiran = new Chart(ctx1, {
                    type: 'line',
                    data: generateKehadiranData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Chart 2: Distribusi Nilai
            const ctx2 = document.getElementById('chartDistribusiNilai');
            if (ctx2) {
                currentCharts.overview.distribusi = new Chart(ctx2, {
                    type: 'bar',
                    data: generateDistribusiNilaiData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Chart 3: Perbandingan Kelas
            const ctx3 = document.getElementById('chartPerbandinganKelas');
            if (ctx3) {
                currentCharts.overview.perbandingan = new Chart(ctx3, {
                    type: 'radar',
                    data: generatePerbandinganData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            // Chart 4: Top Performers
            const ctx4 = document.getElementById('chartTopPerformers');
            if (ctx4) {
                currentCharts.overview.topPerformers = new Chart(ctx4, {
                    type: 'doughnut',
                    data: generateTopPerformersData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            }
        }

        function initializeAnalyticsCharts() {
            console.log('üîç Initializing analytics charts...');
            
            // Analytics Charts
            const ctx5 = document.getElementById('chartKorelasi');
            if (ctx5) {
                currentCharts.analytics.korelasi = new Chart(ctx5, {
                    type: 'scatter',
                    data: generateKorelasiData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
            
            const ctx6 = document.getElementById('chartTrend');
            if (ctx6) {
                currentCharts.analytics.trend = new Chart(ctx6, {
                    type: 'line',
                    data: generateTrendData(),
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }
        }

        function loadPresensiData() {
            console.log('‚úÖ Loading presensi data for tab...');
            // Data sudah di-load di updatePresensiTab()
        }

        function loadNilaiData() {
            console.log('üìä Loading nilai data for tab...');
            // Data sudah di-load di updateNilaiTab()
        }

        // Chart data generation functions
        function generateKehadiranData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'];
            const actualData = calculateMonthlyAttendance();
            
            return {
                labels: months,
                datasets: [{
                    label: 'Persentase Kehadiran',
                    data: actualData,
                    borderColor: CHART_COLORS.success,
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };
        }

        function calculateMonthlyAttendance() {
            // Calculate actual monthly attendance from data
            const monthlyData = [85, 88, 82, 90, 87, 92]; // Default fallback
            
            if (currentData.absensi.length > 0) {
                // Implement actual monthly calculation here
                // This is a simplified version
                const monthlyAttendance = currentData.absensi.reduce((acc, absensi) => {
                    const month = new Date(absensi.tanggal).getMonth();
                    if (!acc[month]) acc[month] = { hadir: 0, total: 0 };
                    acc[month].total++;
                    if (absensi.status === 'H') acc[month].hadir++;
                    return acc;
                }, {});
                
                return Object.keys(monthlyAttendance).map(month => {
                    const data = monthlyAttendance[month];
                    return data.total > 0 ? Math.round((data.hadir / data.total) * 100) : 0;
                });
            }
            
            return monthlyData;
        }

        function generateDistribusiNilaiData() {
            const distribusi = calculateNilaiDistribution();
            
            return {
                labels: ['0-50', '51-60', '61-70', '71-80', '81-90', '91-100'],
                datasets: [{
                    label: 'Jumlah Siswa',
                    data: distribusi,
                    backgroundColor: CHART_COLORS.primary,
                    borderColor: CHART_COLORS.primary,
                    borderWidth: 1
                }]
            };
        }

        function calculateNilaiDistribution() {
            const distribusi = [0, 0, 0, 0, 0, 0];
            
            currentData.nilai.forEach(nilai => {
                const nilaiNum = parseFloat(nilai.nilai);
                if (!isNaN(nilaiNum)) {
                    if (nilaiNum <= 50) distribusi[0]++;
                    else if (nilaiNum <= 60) distribusi[1]++;
                    else if (nilaiNum <= 70) distribusi[2]++;
                    else if (nilaiNum <= 80) distribusi[3]++;
                    else if (nilaiNum <= 90) distribusi[4]++;
                    else distribusi[5]++;
                }
            });
            
            return distribusi;
        }

        function generatePerbandinganData() {
            const kelasData = calculateKelasComparison();
            
            return {
                labels: ['Kehadiran', 'Nilai MTK', 'Nilai BINDO', 'Nilai IPAS', 'Rata-rata'],
                datasets: kelasData
            };
        }

        function calculateKelasComparison() {
            // Simplified kelas comparison
            return [
                {
                    label: 'Kelas 1',
                    data: [85, 78, 82, 0, 79], // IPAS = 0 untuk kelas 1
                    borderColor: CHART_COLORS.primary,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)'
                },
                {
                    label: 'Kelas 2',
                    data: [88, 82, 85, 0, 82], // IPAS = 0 untuk kelas 2
                    borderColor: CHART_COLORS.success,
                    backgroundColor: 'rgba(72, 187, 120, 0.2)'
                },
                {
                    label: 'Kelas 3',
                    data: [90, 85, 88, 82, 85], // IPAS ada untuk kelas 3
                    borderColor: CHART_COLORS.warning,
                    backgroundColor: 'rgba(237, 137, 54, 0.2)'
                }
            ];
        }

        function generateTopPerformersData() {
            const performers = calculateTopPerformers();
            
            return {
                labels: ['Sangat Baik', 'Baik', 'Cukup', 'Perlu Improvement'],
                datasets: [{
                    data: performers,
                    backgroundColor: [
                        CHART_COLORS.success,
                        CHART_COLORS.info,
                        CHART_COLORS.warning,
                        CHART_COLORS.danger
                    ]
                }]
            };
        }

        function calculateTopPerformers() {
            const nilaiRekap = calculateNilaiRekap();
            let sangatBaik = 0, baik = 0, cukup = 0, perluImprovement = 0;
            
            nilaiRekap.forEach(siswa => {
                if (siswa.rataRata >= 85) sangatBaik++;
                else if (siswa.rataRata >= 75) baik++;
                else if (siswa.rataRata >= 65) cukup++;
                else perluImprovement++;
            });
            
            return [sangatBaik, baik, cukup, perluImprovement];
        }

        function generateKorelasiData() {
            const korelasi = calculateKorelasi();
            
            return {
                datasets: [{
                    label: 'Siswa',
                    data: korelasi,
                    backgroundColor: CHART_COLORS.primary
                }]
            };
        }

        function calculateKorelasi() {
            const korelasiData = [];
            const nilaiRekap = calculateNilaiRekap();
            const absensiRekap = calculateAbsensiRekap();
            
            nilaiRekap.forEach(nilai => {
                const absensi = absensiRekap.find(p => p.nama === nilai.nama && p.kelas === nilai.kelas);
                if (absensi) {
                    const persentase = absensi.total > 0 ? Math.round((absensi.hadir / absensi.total) * 100) : 0;
                    if (nilai.rataRata > 0 && persentase > 0) {
                        korelasiData.push({
                            x: persentase,
                            y: nilai.rataRata
                        });
                    }
                }
            });
            
            return korelasiData.length > 0 ? korelasiData : [
                {x: 85, y: 80}, {x: 92, y: 88}, {x: 78, y: 75},
                {x: 65, y: 62}, {x: 88, y: 85}, {x: 95, y: 92}
            ];
        }

        function generateTrendData() {
            return {
                labels: ['Minggu 1', 'Minggu 2', 'Minggu 3', 'Minggu 4'],
                datasets: [
                    {
                        label: 'Kehadiran',
                        data: [85, 88, 82, 90],
                        borderColor: CHART_COLORS.success,
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Nilai Rata-rata',
                        data: [75, 78, 82, 85],
                        borderColor: CHART_COLORS.primary,
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }
                ]
            };
        }

        // ==================== UTILITY FUNCTIONS ====================

        function resetFilter() {
            document.getElementById('filterKelas').value = 'all';
            document.getElementById('filterBulan').value = 'all';
            // Tahun tetap di tahun saat ini
            const currentYear = new Date().getFullYear();
            document.getElementById('filterTahun').value = currentYear;
            document.getElementById('filterMapel').value = 'all';
            showNotification('üîÑ Filter telah direset', 'info', 2000);
        }

        // Custom Notification System
        function showNotification(message, type = 'info', duration = 4000) {
            const existingNotification = document.getElementById('custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.id = 'custom-notification';
            
            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                warning: '#ed8936',
                info: '#4299e1'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span>${message}</span>
                </div>
            `;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                maxWidth: '400px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                animation: 'slideIn 0.3s ease',
                fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                cursor: 'pointer',
                background: colors[type] || colors.info
            });
            
            document.body.appendChild(notification);
            
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            });
            
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
        }

        function logout() {
            console.log('üö™ Logging out...');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '../index.html';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Laporan page loaded');
            
            // Generate tahun options pertama kali
            generateTahunOptions();
            
            // Tambahkan event listener untuk perubahan kelas
            document.getElementById('filterKelas').addEventListener('change', function() {
                loadMataPelajaran();
                // Reset pilihan mapel ketika kelas berubah
                document.getElementById('filterMapel').value = 'all';
            });
            
            // Pastikan tab pertama aktif saat load
            setTimeout(() => {
                const firstTab = document.querySelector('.tab-btn');
                if (firstTab) {
                    firstTab.classList.add('active');
                }
                const firstTabContent = document.getElementById('tab-overview');
                if (firstTabContent) {
                    firstTabContent.classList.add('active');
                }
            }, 100);
            
            loadLaporanPage();
        });
    </script>
</body>
</html>