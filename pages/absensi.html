<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Siswa - SDN Karangsari</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <!-- Library untuk Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Logo Styles - Diperbarui untuk konsistensi */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-icon, .header-logo-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: contain;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo-fallback, .header-logo-fallback {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-school {
            font-weight: 700;
            font-size: 16px;
            color: white;
        }

        .logo-subtitle {
            font-size: 10px;
            color: #e2e8f0;
            opacity: 0.8;
        }

        /* Header Logo */
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo-text {
            display: flex;
            flex-direction: column;
        }

        .header-school {
            font-weight: 700;
            font-size: 18px;
            color: #2d3748;
        }

        .header-subtitle {
            font-size: 11px;
            color: #718096;
        }

        /* Role Badge - Diperbarui untuk konsistensi */
        .role-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }

        .stat-card .subvalue {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }

        /* Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover, .btn-success:hover, .btn-warning:hover, .btn-info:hover, .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Export Buttons Group */
        .export-buttons-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .export-btn-excel {
            background: linear-gradient(135deg, #21a366, #107c41);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .export-btn-pdf {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .export-btn-excel:hover, .export-btn-pdf:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 25px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .table-header h3 {
            margin: 0;
            color: #2d3748;
            font-size: 18px;
        }

        .table-header p {
            margin: 5px 0 0 0;
            color: #718096;
            font-size: 14px;
        }

        /* Absensi Table */
        .absensi-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .absensi-table th {
            background: #f7fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
        }

        .absensi-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .absensi-table tr:hover {
            background: #f7fafc;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-hadir {
            background: #c6f6d5;
            color: #276749;
        }

        .status-izin {
            background: #fed7d7;
            color: #c53030;
        }

        .status-sakit {
            background: #feebc8;
            color: #744210;
        }

        .status-alpha {
            background: #e2e8f0;
            color: #4a5568;
        }

        /* Radio Buttons */
        .radio-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 500;
        }

        .radio-label:hover {
            border-color: #667eea;
        }

        .radio-label input[type="radio"] {
            display: none;
        }

        .radio-label input[type="radio"]:checked + .radio-custom {
            background: #667eea;
            border-color: #667eea;
        }

        .radio-label input[type="radio"]:checked + .radio-custom::after {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        .radio-custom {
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        /* Student Info */
        .student-name {
            font-weight: 600;
            color: #2d3748;
        }

        .student-id {
            font-size: 12px;
            color: #718096;
            font-family: monospace;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Progress Info */
        .progress-info {
            background: #f0fff4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #9ae6b4;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.3s;
        }

        /* Tabs Navigation */
        .tabs-container {
            background: white;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .tab-btn {
            padding: 15px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-btn:hover:not(.active) {
            color: #4a5568;
            background: #edf2f7;
        }

        .tab-content {
            display: none;
            padding: 25px;
        }

        .tab-content.active {
            display: block;
        }

        /* Rekap Table */
        .rekap-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rekap-table th {
            background: #f7fafc;
            padding: 12px 16px;
            text-align: center;
            font-weight: 600;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            font-size: 12px;
        }

        .rekap-table td {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            text-align: center;
            vertical-align: middle;
            font-size: 12px;
        }

        .rekap-table .student-name-cell {
            text-align: left;
            font-weight: 600;
        }

        .day-cell {
            width: 30px;
            cursor: pointer;
        }

        .day-cell.hadir { background: #c6f6d5; color: #276749; }
        .day-cell.izin { background: #fed7d7; color: #c53030; }
        .day-cell.sakit { background: #feebc8; color: #744210; }
        .day-cell.alpha { background: #e2e8f0; color: #4a5568; }
        .day-cell.weekend { background: #f7fafc; color: #a0aec0; }

        /* Notification Styles */
        #custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            cursor: pointer;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-primary, .btn-success, .btn-warning, .btn-info, .btn-secondary {
                width: 100%;
                text-align: center;
            }
            
            .radio-group {
                justify-content: center;
            }
            
            .tabs-nav {
                flex-direction: column;
            }
            
            .tab-btn {
                text-align: center;
                border-bottom: 1px solid #e2e8f0;
                border-left: 3px solid transparent;
            }
            
            .tab-btn.active {
                border-left-color: #667eea;
                border-bottom-color: #e2e8f0;
            }
            
            .export-buttons-group {
                flex-direction: column;
            }
            
            .export-btn-excel, .export-btn-pdf {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-container">
                <img src="../assets/images/logo.png" alt="Logo SDN Karangsari" class="logo-icon" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='flex';">
                <div id="logo-fallback" class="logo-fallback" style="display: none;">SD</div>
                <div class="logo-text">
                    <div class="logo-school">SDN KARANGSARI</div>
                    <div class="logo-subtitle">MANAJEMEN KELAS</div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="manajemen-kelas.html" class="nav-item">
                    <span>üë•</span>
                    <span>Manajemen Kelas</span>
                </a>
                <a href="input-nilai.html" class="nav-item">
                    <span>üìù</span>
                    <span>Input Nilai</span>
                </a>
                <a href="absensi.html" class="nav-item active">
                    <span>‚úÖ</span>
                    <span>Absensi</span>
                </a>
                <a href="laporan.html" class="nav-item">
                    <span>üìã</span>
                    <span>Laporan</span>
                </a>
                <button onclick="logout()" class="nav-item logout">
                    <span>üö™</span>
                    <span>Logout</span>
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <header class="header">
                <div class="header-logo">
                    <img src="../assets/images/logo.png" alt="Logo SDN Karangsari" class="header-logo-icon" onerror="this.style.display='none'; document.getElementById('header-logo-fallback').style.display='flex';">
                    <div id="header-logo-fallback" class="header-logo-fallback" style="display: none;">SD</div>
                    <div class="header-logo-text">
                        <div class="header-school">SDN KARANGSARI</div>
                        <div class="header-subtitle">SISTEM ABSENSI DIGITAL</div>
                    </div>
                </div>
                <div class="user-info">
                    <span id="userName"></span>
                    <span id="userRole" class="role-badge"></span>
                </div>
            </header>
            
            <div class="dashboard-content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Siswa</h3>
                        <div class="value" id="totalSiswa">0</div>
                        <div class="subvalue" id="infoKelas">Pilih kelas</div>
                    </div>
                    <div class="stat-card">
                        <h3>Hadir Hari Ini</h3>
                        <div class="value" id="hadirHariIni">0</div>
                        <div class="subvalue" id="tanggalHariIni">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Tidak Hadir</h3>
                        <div class="value" id="tidakHadir">0</div>
                        <div class="subvalue">Izin + Sakit + Alpha</div>
                    </div>
                    <div class="stat-card">
                        <h3>Persentase Hadir</h3>
                        <div class="value" id="persentaseHadir">0%</div>
                        <div class="subvalue" id="infoBulan">Bulan ini</div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" onclick="showTab('harian')">üìÖ Absensi Harian</button>
                        <button class="tab-btn" onclick="showTab('rekap')">üìä Rekap Bulanan</button>
                    </div>

                    <!-- Tab: Absensi Harian -->
                    <div id="tab-harian" class="tab-content active">
                        <!-- Filter Section -->
                        <div class="filter-section">
                            <div class="filter-grid">
                                <div class="filter-group">
                                    <label class="filter-label">Kelas</label>
                                    <select id="filterKelas" class="filter-select">
                                        <option value="">Pilih Kelas</option>
                                        <option value="1">Kelas 1</option>
                                        <option value="2">Kelas 2</option>
                                        <option value="3">Kelas 3</option>
                                        <option value="4">Kelas 4</option>
                                        <option value="5">Kelas 5</option>
                                        <option value="6">Kelas 6</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Tanggal</label>
                                    <input type="date" id="filterTanggal" class="filter-input" value="">
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Periode</label>
                                    <select id="filterPeriode" class="filter-select">
                                        <option value="hari-ini">Hari Ini</option>
                                        <option value="kemarin">Kemarin</option>
                                        <option value="minggu-ini">Minggu Ini</option>
                                        <option value="bulan-ini">Bulan Ini</option>
                                        <option value="custom">Pilih Periode Kustom</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button onclick="loadAbsensiHariIni()" class="btn-primary" id="btnLoadAbsensi">
                                    <span id="btnLoadText">üìä Muat Data Absensi</span>
                                    <span id="btnLoadLoading" class="loading-spinner" style="display: none;"></span>
                                </button>
                                <button onclick="simpanSemuaAbsensi()" class="btn-success" id="btnSimpan" disabled>
                                    üíæ Simpan Semua Absensi
                                </button>
                                <button onclick="resetAbsensi()" class="btn-secondary">
                                    üîÑ Reset Form
                                </button>
                            </div>

                            <!-- Export Buttons Group -->
                            <div class="export-buttons-group">
                                <button onclick="exportExcel('harian')" class="export-btn-excel">
                                    üìä Excel Harian
                                </button>
                                <button onclick="exportPDF('harian')" class="export-btn-pdf">
                                    üìÑ PDF Harian
                                </button>
                            </div>
                        </div>

                        <!-- Progress Info -->
                        <div class="progress-info" id="progressInfo" style="display: none;">
                            <h4 style="margin: 0 0 10px 0; color: #276749;">üìà Progress Input Absensi</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; color: #4a5568;">
                                <span id="progressText">Mengambil data...</span>
                                <span id="progressPercentage">0%</span>
                            </div>
                        </div>

                        <!-- Table Absensi -->
                        <div class="table-container">
                            <div class="table-header">
                                <h3 id="tableTitle">Form Absensi Harian</h3>
                                <p id="tableDescription">Pilih kelas dan tanggal terlebih dahulu</p>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <table class="absensi-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">No</th>
                                            <th style="width: 120px;">ID Siswa</th>
                                            <th>Nama Siswa</th>
                                            <th style="width: 200px;">Status Kehadiran</th>
                                            <th style="width: 150px;">Keterangan</th>
                                            <th style="width: 120px;">Terakhir Update</th>
                                            <th style="width: 100px;">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="absensiTableBody">
                                        <tr>
                                            <td colspan="7">
                                                <div class="empty-state">
                                                    <div class="empty-state-icon">‚úÖ</div>
                                                    <p>Belum ada data untuk ditampilkan</p>
                                                    <small>Pilih filter di atas dan klik "Muat Data Absensi"</small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Rekap Bulanan -->
                    <div id="tab-rekap" class="tab-content">
                        <!-- Filter Section -->
                        <div class="filter-section">
                            <div class="filter-grid">
                                <div class="filter-group">
                                    <label class="filter-label">Kelas</label>
                                    <select id="filterKelasRekap" class="filter-select">
                                        <option value="">Pilih Kelas</option>
                                        <option value="1">Kelas 1</option>
                                        <option value="2">Kelas 2</option>
                                        <option value="3">Kelas 3</option>
                                        <option value="4">Kelas 4</option>
                                        <option value="5">Kelas 5</option>
                                        <option value="6">Kelas 6</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Bulan</label>
                                    <select id="filterBulanRekap" class="filter-select">
                                        <option value="1">Januari</option>
                                        <option value="2">Februari</option>
                                        <option value="3">Maret</option>
                                        <option value="4">April</option>
                                        <option value="5">Mei</option>
                                        <option value="6">Juni</option>
                                        <option value="7">Juli</option>
                                        <option value="8">Agustus</option>
                                        <option value="9">September</option>
                                        <option value="10">Oktober</option>
                                        <option value="11">November</option>
                                        <option value="12">Desember</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label class="filter-label">Tahun</label>
                                    <select id="filterTahunRekap" class="filter-select">
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button onclick="loadRekapBulanan()" class="btn-primary" id="btnLoadRekap">
                                    <span id="btnLoadRekapText">üìä Muat Rekap Bulanan</span>
                                    <span id="btnLoadRekapLoading" class="loading-spinner" style="display: none;"></span>
                                </button>
                            </div>

                            <!-- Export Buttons Group -->
                            <div class="export-buttons-group">
                                <button onclick="exportExcel('bulanan')" class="export-btn-excel">
                                    üìä Excel Bulanan
                                </button>
                                <button onclick="exportPDF('bulanan')" class="export-btn-pdf">
                                    üìÑ PDF Bulanan
                                </button>
                            </div>
                        </div>

                        <!-- Stats Rekap -->
                        <div class="stats-grid" id="rekapStats" style="display: none;">
                            <div class="stat-card">
                                <h3>Rata-rata Kehadiran</h3>
                                <div class="value" id="rataKehadiran">0%</div>
                                <div class="subvalue">Seluruh Bulan</div>
                            </div>
                            <div class="stat-card">
                                <h3>Total Hari Efektif</h3>
                                <div class="value" id="totalHari">0</div>
                                <div class="subvalue">Hari Sekolah</div>
                            </div>
                            <div class="stat-card">
                                <h3>Siswa Terbaik</h3>
                                <div class="value" id="siswaTerbaik">-</div>
                                <div class="subvalue">Kehadiran 100%</div>
                            </div>
                            <div class="stat-card">
                                <h3>Perlu Perhatian</h3>
                                <div class="value" id="perluPerhatian">0</div>
                                <div class="subvalue">Kehadiran &lt; 80%</div>
                            </div>
                        </div>

                        <!-- Table Rekap -->
                        <div class="table-container">
                            <div class="table-header">
                                <h3 id="rekapTableTitle">Rekap Absensi Bulanan</h3>
                                <p id="rekapTableDescription">Pilih kelas, bulan, dan tahun terlebih dahulu</p>
                            </div>
                            
                            <div style="overflow-x: auto;">
                                <div id="rekapTableContainer">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">üìä</div>
                                        <p>Belum ada data rekap</p>
                                        <small>Pilih filter di atas dan klik "Muat Rekap Bulanan"</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Sistem -->
                <div class="progress-info">
                    <h4 style="margin: 0 0 10px 0; color: #276749;">üìã Sistem Absensi Digital</h4>
                    <div style="font-size: 14px; color: #2d3748;">
                        <div><strong>‚úÖ Hadir:</strong> Siswa hadir sesuai jadwal</div>
                        <div><strong>ü§í Sakit:</strong> Siswa tidak hadir karena sakit (dengan surat dokter)</div>
                        <div><strong>üìù Izin:</strong> Siswa tidak hadir dengan alasan tertentu (dengan surat orang tua)</div>
                        <div><strong>‚ùå Alpha:</strong> Siswa tidak hadir tanpa keterangan</div>
                        <div><strong>‚ú® Fitur:</strong> Rekap otomatis, statistik bulanan, export data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Absensi Functions
        let currentUser = null;
        let currentData = {
            siswa: [],
            absensiExisting: {},
            tanggal: new Date().toISOString().split('T')[0],
            rekapData: []
        };

        // Status kehadiran
        const STATUS_KEHADIRAN = [
            { id: 'H', nama: 'Hadir', color: 'status-hadir', icon: '‚úÖ' },
            { id: 'I', nama: 'Izin', color: 'status-izin', icon: 'üìù' },
            { id: 'S', nama: 'Sakit', color: 'status-sakit', icon: 'ü§í' },
            { id: 'A', nama: 'Alpha', color: 'status-alpha', icon: '‚ùå' }
        ];

        async function loadAbsensi() {
            console.log('‚úÖ Loading absensi system...');
            
            currentUser = checkAuth();
            if (!currentUser) {
                console.log('‚ùå User not authenticated, redirecting...');
                window.location.href = '../index.html';
                return;
            }
            
            console.log('‚úÖ User authenticated:', currentUser);
            
            // Display user info
            document.getElementById('userName').textContent = currentUser.nama;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Setup filter berdasarkan role
            setupFilterByRole();
            
            // Set tanggal default ke hari ini
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterTanggal').value = today;
            currentData.tanggal = today;
            
            document.getElementById('tanggalHariIni').textContent = formatTanggal(new Date());
            
            // Set bulan dan tahun default untuk rekap
            const now = new Date();
            document.getElementById('filterBulanRekap').value = now.getMonth() + 1;
            document.getElementById('filterTahunRekap').value = now.getFullYear();
            document.getElementById('infoBulan').textContent = getNamaBulan(now.getMonth() + 1);
            
            // Auto-load data jika guru kelas
            if (currentUser.role === 'Guru Kelas' && currentUser.kelas_dipegang) {
                console.log('üîÑ Auto-loading data for guru kelas...');
                setTimeout(() => {
                    loadAbsensiHariIni();
                }, 1000);
            }
        }

        function setupFilterByRole() {
            const filterKelas = document.getElementById('filterKelas');
            const filterKelasRekap = document.getElementById('filterKelasRekap');
            
            if (currentUser.role === 'Guru Kelas' && currentUser.kelas_dipegang) {
                const kelasAngka = currentUser.kelas_dipegang.replace('A', '');
                filterKelas.value = kelasAngka;
                filterKelas.disabled = true;
                filterKelas.classList.add('filter-disabled');
                
                filterKelasRekap.value = kelasAngka;
                filterKelasRekap.disabled = true;
                filterKelasRekap.classList.add('filter-disabled');
                
                console.log('üéØ Guru kelas - auto select class:', kelasAngka);
            }
        }

        function showTab(tabName) {
            console.log('üîÑ Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate clicked button
            event.target.classList.add('active');
        }

        async function loadAbsensiHariIni() {
            const kelas = document.getElementById('filterKelas').value;
            let tanggal = document.getElementById('filterTanggal').value;
            const periode = document.getElementById('filterPeriode').value;
            
            // Handle periode selection
            if (periode !== 'custom') {
                tanggal = getTanggalByPeriode(periode);
                document.getElementById('filterTanggal').value = tanggal;
            }
            
            if (!kelas) {
                showNotification('‚ùå Harap pilih Kelas terlebih dahulu', 'error', 3000);
                return;
            }
            
            if (!tanggal) {
                showNotification('‚ùå Harap pilih Tanggal terlebih dahulu', 'error', 3000);
                return;
            }
            
            // Show loading
            const btnLoad = document.getElementById('btnLoadAbsensi');
            const btnLoadText = document.getElementById('btnLoadText');
            const btnLoadLoading = document.getElementById('btnLoadLoading');
            
            btnLoad.disabled = true;
            btnLoadText.style.display = 'none';
            btnLoadLoading.style.display = 'inline-block';
            
            try {
                console.log('üìä Loading absensi...', { kelas, tanggal });
                
                // 1. Load data siswa
                const { data: siswa, error: errorSiswa } = await supabase
                    .from('siswa')
                    .select('*')
                    .eq('kelas', kelas)
                    .eq('status', true)
                    .order('nama_siswa');
                
                if (errorSiswa) {
                    console.error('‚ùå Error loading siswa:', errorSiswa);
                    throw errorSiswa;
                }
                
                currentData.siswa = siswa || [];
                currentData.tanggal = tanggal;
                
                console.log('‚úÖ Siswa loaded:', currentData.siswa.length);
                
                // 2. Load absensi untuk tanggal yang dipilih
                await loadAbsensiExisting(kelas, tanggal);
                
                // Update UI
                updateStats();
                displayAbsensiTable();
                document.getElementById('btnSimpan').disabled = false;
                document.getElementById('progressInfo').style.display = 'block';
                
                showNotification(`‚úÖ Data ${currentData.siswa.length} siswa berhasil dimuat`, 'success', 2000);
                
            } catch (error) {
                console.error('‚ùå Error loading absensi:', error);
                showNotification('Gagal memuat data absensi: ' + error.message, 'error', 4000);
                
                // Show error state
                const tbody = document.getElementById('absensiTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚ùå</div>
                                <p>Gagal memuat data absensi</p>
                                <small>${error.message}</small>
                            </div>
                        </td>
                    </tr>
                `;
            } finally {
                // Hide loading
                btnLoad.disabled = false;
                btnLoadText.style.display = 'inline-block';
                btnLoadLoading.style.display = 'none';
            }
        }

        function getTanggalByPeriode(periode) {
            const now = new Date();
            let resultDate = new Date();
            
            switch(periode) {
                case 'hari-ini':
                    return now.toISOString().split('T')[0];
                case 'kemarin':
                    resultDate.setDate(now.getDate() - 1);
                    return resultDate.toISOString().split('T')[0];
                case 'minggu-ini':
                    // Senin minggu ini
                    const day = now.getDay();
                    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    resultDate.setDate(diff);
                    return resultDate.toISOString().split('T')[0];
                case 'bulan-ini':
                    // Tanggal 1 bulan ini
                    return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                default:
                    return now.toISOString().split('T')[0];
            }
        }

        async function loadAbsensiExisting(kelas, tanggal) {
            try {
                console.log('üìã Loading existing absensi...');
                
                const { data: absensi, error } = await supabase
                    .from('absensi')
                    .select('*')
                    .eq('kelas', kelas)
                    .eq('tanggal', tanggal);
                
                if (error) {
                    console.error('‚ùå Error loading existing absensi:', error);
                    throw error;
                }
                
                // Organize data by siswa_id
                currentData.absensiExisting = {};
                
                if (absensi && absensi.length > 0) {
                    absensi.forEach(absen => {
                        currentData.absensiExisting[absen.siswa_id] = absen;
                    });
                    console.log('‚úÖ Existing absensi loaded:', absensi.length, 'records');
                } else {
                    console.log('‚ÑπÔ∏è No existing absensi found for this date');
                }
                
            } catch (error) {
                console.error('‚ùå Error in loadAbsensiExisting:', error);
                // Continue without existing data
                currentData.absensiExisting = {};
            }
        }

        function displayAbsensiTable() {
            const tbody = document.getElementById('absensiTableBody');
            
            if (!currentData.siswa || currentData.siswa.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <p>Tidak ada siswa di kelas ini</p>
                                <small>Silakan pilih kelas lain</small>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const tanggal = document.getElementById('filterTanggal').value;
            
            tbody.innerHTML = currentData.siswa.map((siswa, index) => {
                const existingAbsen = currentData.absensiExisting[siswa.id_siswa];
                const status = existingAbsen ? existingAbsen.status : 'H'; // Default Hadir
                const keterangan = existingAbsen ? existingAbsen.keterangan : '';
                const lastUpdate = existingAbsen ? existingAbsen.updated_at : null;
                
                return `
                    <tr>
                        <td style="padding: 12px; text-align: center;">${index + 1}</td>
                        <td style="padding: 12px;">
                            <div class="student-id">${siswa.id_siswa}</div>
                        </td>
                        <td style="padding: 12px;">
                            <div class="student-name">${siswa.nama_siswa}</div>
                            <div style="font-size: 12px; color: #718096;">
                                ${siswa.jk === 'L' ? 'üë¶' : 'üëß'} ${siswa.jk === 'L' ? 'Laki-laki' : 'Perempuan'}
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <div class="radio-group">
                                ${STATUS_KEHADIRAN.map(statusItem => `
                                    <label class="radio-label">
                                        <input type="radio" 
                                               name="status_${siswa.id_siswa}" 
                                               value="${statusItem.id}"
                                               ${status === statusItem.id ? 'checked' : ''}
                                               onchange="updateStatus('${siswa.id_siswa}', '${statusItem.id}')">
                                        <span class="radio-custom"></span>
                                        <span>${statusItem.icon} ${statusItem.nama}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </td>
                        <td style="padding: 12px;">
                            <input type="text" 
                                   class="filter-input" 
                                   style="width: 100%; padding: 8px; font-size: 12px;"
                                   placeholder="Keterangan (opsional)"
                                   value="${keterangan}"
                                   data-siswa-id="${siswa.id_siswa}"
                                   onchange="updateKeterangan('${siswa.id_siswa}', this.value)"
                                   onblur="updateKeterangan('${siswa.id_siswa}', this.value)">
                        </td>
                        <td style="padding: 12px;">
                            ${lastUpdate ? `
                                <span style="font-size: 12px; color: #718096;">
                                    ${new Date(lastUpdate).toLocaleDateString('id-ID')}
                                    <br>
                                    <small>${new Date(lastUpdate).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}</small>
                                </span>
                            ` : '<span style="color: #a0aec0; font-size: 12px;">-</span>'}
                        </td>
                        <td style="padding: 12px;">
                            <button onclick="simpanAbsensi('${siswa.id_siswa}')" 
                                    class="btn-success" 
                                    style="padding: 6px 12px; font-size: 12px; border: none; border-radius: 5px; cursor: pointer;">
                                üíæ Simpan
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateTableInfo();
            updateProgress();
        }

        function updateStatus(siswaId, status) {
            console.log(`üîÑ Update status ${siswaId} to ${status}`);
        }

        function updateKeterangan(siswaId, keterangan) {
            console.log(`üìù Update keterangan ${siswaId}: ${keterangan}`);
        }

        async function simpanAbsensi(siswaId) {
            const statusRadio = document.querySelector(`input[name="status_${siswaId}"]:checked`);
            const keteranganInput = document.querySelector(`input[data-siswa-id="${siswaId}"]`);
            
            if (!statusRadio) {
                showNotification('‚ùå Harap pilih status kehadiran terlebih dahulu', 'error', 2000);
                return;
            }
            
            const status = statusRadio.value;
            const keterangan = keteranganInput ? keteranganInput.value : '';
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('filterTanggal').value;
            
            // Validasi data
            if (!siswaId || !kelas || !tanggal) {
                showNotification('‚ùå Data tidak lengkap. Harap muat ulang halaman.', 'error', 3000);
                return;
            }
            
            // Show loading state on button
            const saveButton = document.querySelector(`button[onclick="simpanAbsensi('${siswaId}')"]`);
            const originalText = saveButton.innerHTML;
            const originalBackground = saveButton.style.background;
            saveButton.innerHTML = '‚è≥ Menyimpan...';
            saveButton.disabled = true;
            
            try {
                console.log('üíæ Saving absensi:', { 
                    siswaId, status, keterangan, kelas, tanggal 
                });
                
                const absensiData = {
                    siswa_id: siswaId,
                    kelas: kelas,
                    tanggal: tanggal,
                    status: status,
                    keterangan: keterangan,
                    created_by: currentUser.id_guru,
                    updated_at: new Date().toISOString()
                };
                
                // Cek apakah absensi sudah ada
                const existingAbsen = currentData.absensiExisting[siswaId];
                
                let result;
                let isUpdate = false;
                
                if (existingAbsen && existingAbsen.id) {
                    // Update existing
                    console.log('üîÑ Updating existing absensi...');
                    isUpdate = true;
                    result = await supabase
                        .from('absensi')
                        .update(absensiData)
                        .eq('id', existingAbsen.id);
                } else {
                    // Insert new
                    console.log('üÜï Inserting new absensi...');
                    absensiData.created_at = new Date().toISOString();
                    result = await supabase
                        .from('absensi')
                        .insert([absensiData]);
                }
                
                if (result.error) {
                    console.error('‚ùå Database error:', result.error);
                    
                    // Handle specific errors
                    if (result.error.code === '23505') { // Unique violation
                        console.log('‚ö†Ô∏è Data sudah ada, mencoba update...');
                        // Try to update using composite key
                        const updateResult = await supabase
                            .from('absensi')
                            .update(absensiData)
                            .eq('siswa_id', siswaId)
                            .eq('tanggal', tanggal);
                        
                        if (updateResult.error) throw updateResult.error;
                        result = updateResult;
                        isUpdate = true;
                    } else {
                        throw result.error;
                    }
                }
                
                // FIX: Handle null result.data dengan safe check
                let newId;
                if (isUpdate) {
                    newId = existingAbsen ? existingAbsen.id : null;
                } else {
                    // Safe check untuk result.data[0] - FIXED!
                    newId = result.data && Array.isArray(result.data) && result.data.length > 0 ? result.data[0].id : Date.now().toString();
                }
                
                // Show success feedback
                const successMessage = `‚úÖ Absensi ${getStatusName(status)} berhasil disimpan!`;
                console.log(successMessage);
                
                // Update button dengan feedback visual
                saveButton.innerHTML = '‚úÖ Tersimpan';
                saveButton.style.background = '#48bb78';
                
                // Update local data
                currentData.absensiExisting[siswaId] = { 
                    ...absensiData, 
                    id: newId
                };
                
                updateProgress();
                updateStats();
                
                // Show success notification (akan auto hilang dalam 1.5 detik)
                showNotification(successMessage, 'success', 1500);
                
                // Reset button setelah 2 detik
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.background = originalBackground;
                    saveButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error saving absensi:', error);
                
                // Show error feedback on button
                saveButton.innerHTML = '‚ùå Gagal';
                saveButton.style.background = '#e53e3e';
                
                // Show notification instead of alert (akan auto hilang dalam 3 detik)
                let errorMessage = 'Gagal menyimpan absensi: ';
                if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Koneksi internet bermasalah';
                } else if (error.message.includes('JWT')) {
                    errorMessage += 'Sesi login habis, silakan login kembali';
                } else if (error.message.includes('null') && error.message.includes('0')) {
                    errorMessage += 'Terjadi kesalahan sistem. Data mungkin tidak tersimpan dengan benar.';
                } else {
                    errorMessage += error.message;
                }
                
                showNotification(errorMessage, 'error', 3000);
                
                // Reset button setelah 3 detik
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.background = originalBackground;
                    saveButton.disabled = false;
                }, 3000);
            }
        }

        async function simpanSemuaAbsensi() {
            if (!currentData.siswa || currentData.siswa.length === 0) {
                showNotification('‚ùå Tidak ada data siswa untuk disimpan', 'error', 3000);
                return;
            }
            
            // Show custom confirm
            const userConfirmed = await showConfirm(
                'Simpan Semua Absensi',
                'üíæ Simpan semua absensi yang telah diinput?\n\nSistem akan menyimpan data untuk semua siswa.',
                'Simpan Semua',
                'Batal'
            );
            
            if (!userConfirmed) {
                return;
            }
            
            const btnSimpan = document.getElementById('btnSimpan');
            const originalText = btnSimpan.innerHTML;
            const originalBackground = btnSimpan.style.background;
            
            try {
                btnSimpan.disabled = true;
                btnSimpan.innerHTML = '‚è≥ Menyimpan...';
                btnSimpan.style.background = '#ed8936';
                
                let successCount = 0;
                let errorCount = 0;
                const totalSiswa = currentData.siswa.length;
                
                // Show progress notification
                const progressNotification = showNotification(`‚è≥ Menyimpan data ${totalSiswa} siswa...`, 'info', 0);
                progressNotification.id = 'progress-notification';
                
                // Update progress content
                progressNotification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; width: 300px;">
                        <span style="font-size: 16px;">‚è≥</span>
                        <div style="flex: 1;">
                            <div>Menyimpan data ${totalSiswa} siswa...</div>
                            <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 5px;">
                                <div id="progress-bar-fill" style="height: 100%; background: white; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Simpan satu per satu
                for (let i = 0; i < currentData.siswa.length; i++) {
                    const siswa = currentData.siswa[i];
                    
                    try {
                        await simpanAbsensiIndividu(siswa.id_siswa);
                        successCount++;
                    } catch (error) {
                        console.error(`‚ùå Gagal menyimpan absensi ${siswa.nama_siswa}:`, error);
                        errorCount++;
                    }
                    
                    // Update progress bar
                    const progressPercent = Math.round(((i + 1) / totalSiswa) * 100);
                    const progressBar = document.getElementById('progress-bar-fill');
                    if (progressBar) {
                        progressBar.style.width = `${progressPercent}%`;
                    }
                    
                    // Small delay antara penyimpanan
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Remove progress notification
                if (progressNotification.parentNode) {
                    progressNotification.remove();
                }
                
                // Show result notification
                let message, type;
                if (errorCount === 0) {
                    message = `‚úÖ Semua ${successCount} data berhasil disimpan!`;
                    type = 'success';
                } else {
                    message = `‚ö†Ô∏è ${successCount} berhasil, ${errorCount} gagal dari ${totalSiswa} siswa`;
                    type = 'warning';
                }
                
                showNotification(message, type, 4000);
                
                // Refresh data untuk update UI
                await loadAbsensiHariIni();
                
            } catch (error) {
                console.error('‚ùå Error in simpanSemuaAbsensi:', error);
                // Remove progress notification if exists
                const progressNotification = document.getElementById('progress-notification');
                if (progressNotification && progressNotification.parentNode) {
                    progressNotification.remove();
                }
                showNotification('Terjadi kesalahan saat menyimpan semua data', 'error', 4000);
            } finally {
                btnSimpan.disabled = false;
                btnSimpan.innerHTML = originalText;
                btnSimpan.style.background = originalBackground;
            }
        }

        // Fungsi simpan individu untuk bulk save - FIXED!
        async function simpanAbsensiIndividu(siswaId) {
            return new Promise(async (resolve, reject) => {
                try {
                    const statusRadio = document.querySelector(`input[name="status_${siswaId}"]:checked`);
                    const keteranganInput = document.querySelector(`input[data-siswa-id="${siswaId}"]`);
                    
                    if (!statusRadio) {
                        resolve(); // Skip jika tidak ada status
                        return;
                    }
                    
                    const status = statusRadio.value;
                    const keterangan = keteranganInput ? keteranganInput.value : '';
                    const kelas = document.getElementById('filterKelas').value;
                    const tanggal = document.getElementById('filterTanggal').value;
                    
                    const absensiData = {
                        siswa_id: siswaId,
                        kelas: kelas,
                        tanggal: tanggal,
                        status: status,
                        keterangan: keterangan,
                        created_by: currentUser.id_guru,
                        updated_at: new Date().toISOString()
                    };
                    
                    const existingAbsen = currentData.absensiExisting[siswaId];
                    
                    let result;
                    let isUpdate = false;
                    
                    if (existingAbsen && existingAbsen.id) {
                        // Update existing
                        result = await supabase
                            .from('absensi')
                            .update(absensiData)
                            .eq('id', existingAbsen.id);
                        isUpdate = true;
                    } else {
                        // Insert new
                        absensiData.created_at = new Date().toISOString();
                        result = await supabase
                            .from('absensi')
                            .insert([absensiData]);
                    }
                    
                    if (result.error) {
                        if (result.error.code === '23505') {
                            // Unique violation - try update by composite key
                            const updateResult = await supabase
                                .from('absensi')
                                .update(absensiData)
                                .eq('siswa_id', siswaId)
                                .eq('tanggal', tanggal);
                            if (updateResult.error) throw updateResult.error;
                            result = updateResult;
                            isUpdate = true;
                        } else {
                            throw result.error;
                        }
                    }
                    
                    // Safe update local data - FIXED!
                    let newId;
                    if (isUpdate) {
                        newId = existingAbsen ? existingAbsen.id : null;
                    } else {
                        // Safe check untuk result.data[0]
                        newId = result.data && Array.isArray(result.data) && result.data.length > 0 
                            ? result.data[0].id 
                            : `temp_${siswaId}_${Date.now()}`;
                    }
                    
                    currentData.absensiExisting[siswaId] = { 
                        ...absensiData, 
                        id: newId
                    };
                    
                    resolve();
                    
                } catch (error) {
                    console.error(`‚ùå Error saving absensi for ${siswaId}:`, error);
                    reject(error);
                }
            });
        }

        // ==================== REKAP BULANAN FUNCTIONS ====================

        async function loadRekapBulanan() {
            const kelas = document.getElementById('filterKelasRekap').value;
            const bulan = document.getElementById('filterBulanRekap').value;
            const tahun = document.getElementById('filterTahunRekap').value;
            
            if (!kelas) {
                showNotification('‚ùå Harap pilih Kelas terlebih dahulu', 'error', 3000);
                return;
            }
            
            // Show loading
            const btnLoad = document.getElementById('btnLoadRekap');
            const btnLoadText = document.getElementById('btnLoadRekapText');
            const btnLoadLoading = document.getElementById('btnLoadRekapLoading');
            
            btnLoad.disabled = true;
            btnLoadText.style.display = 'none';
            btnLoadLoading.style.display = 'inline-block';
            
            try {
                console.log('üìä Loading rekap bulanan...', { kelas, bulan, tahun });
                
                // 1. Load data siswa
                const { data: siswa, error: errorSiswa } = await supabase
                    .from('siswa')
                    .select('*')
                    .eq('kelas', kelas)
                    .eq('status', true)
                    .order('nama_siswa');
                
                if (errorSiswa) {
                    console.error('‚ùå Error loading siswa:', errorSiswa);
                    throw errorSiswa;
                }
                
                if (!siswa || siswa.length === 0) {
                    throw new Error('Tidak ada siswa di kelas ini');
                }
                
                // 2. Load absensi untuk bulan yang dipilih
                const startDate = `${tahun}-${bulan.padStart(2, '0')}-01`;
                const endDate = `${tahun}-${bulan.padStart(2, '0')}-${new Date(tahun, bulan, 0).getDate()}`;
                
                const { data: absensi, error: errorAbsensi } = await supabase
                    .from('absensi')
                    .select('*')
                    .eq('kelas', kelas)
                    .gte('tanggal', startDate)
                    .lte('tanggal', endDate);
                
                if (errorAbsensi) {
                    console.error('‚ùå Error loading absensi:', errorAbsensi);
                    throw errorAbsensi;
                }
                
                // 3. Process data untuk rekap
                currentData.rekapData = processRekapData(siswa, absensi || [], bulan, tahun);
                
                // 4. Update UI
                displayRekapTable();
                updateRekapStats();
                document.getElementById('rekapStats').style.display = 'grid';
                
                showNotification(`‚úÖ Rekap bulanan ${getNamaBulan(bulan)} ${tahun} berhasil dimuat`, 'success', 2000);
                
            } catch (error) {
                console.error('‚ùå Error loading rekap bulanan:', error);
                showNotification('Gagal memuat rekap bulanan: ' + error.message, 'error', 4000);
                
                // Show error state
                document.getElementById('rekapTableContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Gagal memuat rekap bulanan</p>
                        <small>${error.message}</small>
                    </div>
                `;
            } finally {
                // Hide loading
                btnLoad.disabled = false;
                btnLoadText.style.display = 'inline-block';
                btnLoadLoading.style.display = 'none';
            }
        }

        function processRekapData(siswa, absensi, bulan, tahun) {
            const rekapData = [];
            const totalHari = new Date(tahun, bulan, 0).getDate();
            
            // Buat array hari dalam bulan
            const hariDalamBulan = [];
            for (let i = 1; i <= totalHari; i++) {
                const tanggal = `${tahun}-${bulan.padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                const hari = new Date(tanggal).getDay();
                hariDalamBulan.push({
                    tanggal: tanggal,
                    hari: hari,
                    isWeekend: hari === 0 || hari === 6 // 0=Minggu, 6=Sabtu
                });
            }
            
            // Process setiap siswa
            siswa.forEach(siswaItem => {
                const siswaRekap = {
                    id_siswa: siswaItem.id_siswa,
                    nama_siswa: siswaItem.nama_siswa,
                    hari: [],
                    totalHadir: 0,
                    totalIzin: 0,
                    totalSakit: 0,
                    totalAlpha: 0,
                    persentaseHadir: 0
                };
                
                // Inisialisasi data hari
                hariDalamBulan.forEach(hari => {
                    const absenHariIni = absensi.find(a => 
                        a.siswa_id === siswaItem.id_siswa && 
                        a.tanggal === hari.tanggal
                    );
                    
                    if (hari.isWeekend) {
                        siswaRekap.hari.push({ status: 'W', tanggal: hari.tanggal });
                    } else if (absenHariIni) {
                        siswaRekap.hari.push({ 
                            status: absenHariIni.status, 
                            tanggal: hari.tanggal 
                        });
                        
                        // Hitung total
                        switch(absenHariIni.status) {
                            case 'H': siswaRekap.totalHadir++; break;
                            case 'I': siswaRekap.totalIzin++; break;
                            case 'S': siswaRekap.totalSakit++; break;
                            case 'A': siswaRekap.totalAlpha++; break;
                        }
                    } else {
                        siswaRekap.hari.push({ status: null, tanggal: hari.tanggal });
                        siswaRekap.totalAlpha++; // Default alpha jika tidak ada data
                    }
                });
                
                // Hitung persentase kehadiran (hanya hari sekolah)
                const totalHariSekolah = hariDalamBulan.filter(h => !h.isWeekend).length;
                if (totalHariSekolah > 0) {
                    siswaRekap.persentaseHadir = Math.round((siswaRekap.totalHadir / totalHariSekolah) * 100);
                }
                
                rekapData.push(siswaRekap);
            });
            
            return rekapData;
        }

        function displayRekapTable() {
            const container = document.getElementById('rekapTableContainer');
            const bulan = document.getElementById('filterBulanRekap').value;
            const tahun = document.getElementById('filterTahunRekap').value;
            const totalHari = new Date(tahun, bulan, 0).getDate();
            
            if (!currentData.rekapData || currentData.rekapData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>Tidak ada data rekap</p>
                        <small>Data tidak ditemukan untuk periode yang dipilih</small>
                    </div>
                `;
                return;
            }
            
            // Buat header untuk hari dalam bulan
            let headerHTML = '';
            for (let i = 1; i <= totalHari; i++) {
                const tanggal = `${tahun}-${bulan.padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                const hari = new Date(tanggal).getDay();
                const isWeekend = hari === 0 || hari === 6;
                headerHTML += `<th style="width: 30px; font-size: 10px; ${isWeekend ? 'background: #f7fafc; color: #a0aec0;' : ''}">${i}</th>`;
            }
            
            // Buat baris untuk setiap siswa
            let rowsHTML = currentData.rekapData.map(siswa => {
                let hariHTML = '';
                siswa.hari.forEach((hari, index) => {
                    const dayClass = getDayClass(hari.status);
                    hariHTML += `<td class="day-cell ${dayClass}" title="${formatTanggalShort(new Date(hari.tanggal))}">${getStatusIcon(hari.status)}</td>`;
                });
                
                return `
                    <tr>
                        <td class="student-name-cell">${siswa.nama_siswa}</td>
                        <td style="text-align: center;">${siswa.totalHadir}</td>
                        <td style="text-align: center;">${siswa.totalIzin}</td>
                        <td style="text-align: center;">${siswa.totalSakit}</td>
                        <td style="text-align: center;">${siswa.totalAlpha}</td>
                        <td style="text-align: center; font-weight: 600; ${getPersentaseColor(siswa.persentaseHadir)}">${siswa.persentaseHadir}%</td>
                        ${hariHTML}
                    </tr>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="rekap-table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 150px;">Nama Siswa</th>
                                <th colspan="5" style="background: #667eea; color: white;">Rekap</th>
                                <th colspan="${totalHari}" style="background: #48bb78; color: white;">Hari dalam Bulan ${getNamaBulan(bulan)} ${tahun}</th>
                            </tr>
                            <tr>
                                <th style="width: 40px;">H</th>
                                <th style="width: 40px;">I</th>
                                <th style="width: 40px;">S</th>
                                <th style="width: 40px;">A</th>
                                <th style="width: 60px;">%</th>
                                ${headerHTML}
                            </tr>
                        </thead>
                        <tbody>
                            ${rowsHTML}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Update table info
            document.getElementById('rekapTableTitle').textContent = 
                `Rekap Absensi Kelas ${document.getElementById('filterKelasRekap').value}`;
            document.getElementById('rekapTableDescription').textContent = 
                `Bulan ${getNamaBulan(bulan)} ${tahun} - ${currentData.rekapData.length} siswa`;
        }

        function getDayClass(status) {
            switch(status) {
                case 'H': return 'hadir';
                case 'I': return 'izin';
                case 'S': return 'sakit';
                case 'A': return 'alpha';
                case 'W': return 'weekend';
                default: return '';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'H': return '‚úÖ';
                case 'I': return 'üìù';
                case 'S': return 'ü§í';
                case 'A': return '‚ùå';
                case 'W': return 'üå¥';
                default: return '';
            }
        }

        function getPersentaseColor(persentase) {
            if (persentase >= 90) return 'color: #276749;';
            if (persentase >= 80) return 'color: #2c5aa0;';
            if (persentase >= 70) return 'color: #744210;';
            return 'color: #c53030;';
        }

        function updateRekapStats() {
            if (!currentData.rekapData || currentData.rekapData.length === 0) return;
            
            // Hitung statistik
            let totalPersentase = 0;
            let siswaTerbaik = [];
            let perluPerhatian = 0;
            let totalHariSekolah = 0;
            
            currentData.rekapData.forEach(siswa => {
                totalPersentase += siswa.persentaseHadir;
                
                if (siswa.persentaseHadir === 100) {
                    siswaTerbaik.push(siswa.nama_siswa);
                }
                
                if (siswa.persentaseHadir < 80) {
                    perluPerhatian++;
                }
            });
            
            // Hitung hari sekolah (exclude weekend)
            const bulan = document.getElementById('filterBulanRekap').value;
            const tahun = document.getElementById('filterTahunRekap').value;
            const totalHari = new Date(tahun, bulan, 0).getDate();
            for (let i = 1; i <= totalHari; i++) {
                const tanggal = `${tahun}-${bulan.padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                const hari = new Date(tanggal).getDay();
                if (hari !== 0 && hari !== 6) { // Bukan minggu dan sabtu
                    totalHariSekolah++;
                }
            }
            
            const rataKehadiran = Math.round(totalPersentase / currentData.rekapData.length);
            const siswaTerbaikText = siswaTerbaik.length > 0 ? 
                (siswaTerbaik.length === 1 ? siswaTerbaik[0] : `${siswaTerbaik.length} siswa`) : 
                '-';
            
            document.getElementById('rataKehadiran').textContent = `${rataKehadiran}%`;
            document.getElementById('totalHari').textContent = totalHariSekolah;
            document.getElementById('siswaTerbaik').textContent = siswaTerbaikText;
            document.getElementById('perluPerhatian').textContent = perluPerhatian;
        }

        // ==================== EXPORT FUNCTIONS ====================

        async function exportExcel(tipe) {
            try {
                console.log(`üìä Exporting ${tipe} to Excel...`);
                
                // Show loading
                showNotification(`‚è≥ Menyiapkan data ${tipe} untuk export Excel...`, 'info', 2000);
                
                let data, fileName, headers, worksheetName;
                
                switch(tipe) {
                    case 'harian':
                        data = prepareExportDataHarian();
                        fileName = `Absensi_Harian_${getExportTimestamp()}.xlsx`;
                        headers = ['No', 'ID Siswa', 'Nama Siswa', 'Status', 'Keterangan', 'Tanggal', 'Kelas'];
                        worksheetName = 'Absensi Harian';
                        break;
                        
                    case 'bulanan':
                        data = prepareExportDataBulanan();
                        fileName = `Rekap_Absensi_${getExportTimestamp()}.xlsx`;
                        headers = ['Nama Siswa', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Persentase'];
                        worksheetName = 'Rekap Bulanan';
                        break;
                        
                    default:
                        throw new Error('Tipe export tidak valid');
                }
                
                if (data.length === 0) {
                    showNotification('‚ùå Tidak ada data untuk diexport', 'error', 3000);
                    return;
                }
                
                // Prepare data for Excel
                const excelData = data.map((item, index) => {
                    if (tipe === 'harian') {
                        return [
                            index + 1,
                            item.id_siswa,
                            item.nama_siswa,
                            getStatusName(item.status),
                            item.keterangan,
                            item.tanggal,
                            `Kelas ${item.kelas}`
                        ];
                    } else {
                        return [
                            item.nama_siswa,
                            item.totalHadir,
                            item.totalIzin,
                            item.totalSakit,
                            item.totalAlpha,
                            `${item.persentaseHadir}%`
                        ];
                    }
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Add headers to data
                const excelDataWithHeaders = [headers, ...excelData];
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelDataWithHeaders);
                
                // Style the header row
                if (!ws['!cols']) ws['!cols'] = [];
                headers.forEach((_, index) => {
                    ws['!cols'][index] = { width: 15 };
                });
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, worksheetName);
                
                // Export to file
                XLSX.writeFile(wb, fileName);
                
                showNotification(`‚úÖ ${tipe} berhasil diexport ke Excel`, 'success', 3000);
                
            } catch (error) {
                console.error('‚ùå Error exporting to Excel:', error);
                showNotification('Gagal export Excel: ' + error.message, 'error', 4000);
            }
        }

        async function exportPDF(tipe) {
            try {
                console.log(`üìÑ Exporting ${tipe} to PDF...`);
                
                // Show loading
                showNotification(`‚è≥ Menyiapkan data ${tipe} untuk export PDF...`, 'info', 2000);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                switch(tipe) {
                    case 'harian':
                        await exportHarianPDF(doc);
                        break;
                        
                    case 'bulanan':
                        await exportBulananPDF(doc);
                        break;
                        
                    default:
                        throw new Error('Tipe export tidak valid');
                }
                
                // Save PDF
                doc.save(`Absensi_${tipe}_${getExportTimestamp()}.pdf`);
                
                showNotification(`‚úÖ ${tipe} berhasil diexport ke PDF`, 'success', 3000);
                
            } catch (error) {
                console.error('‚ùå Error exporting to PDF:', error);
                showNotification('Gagal export PDF: ' + error.message, 'error', 4000);
            }
        }

        async function exportHarianPDF(doc) {
            const data = prepareExportDataHarian();
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('filterTanggal').value;
            
            // Add header
            doc.setFontSize(16);
            doc.setTextColor(40, 40, 40);
            doc.text('LAPORAN ABSENSI HARIAN', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Kelas: ${kelas} | Tanggal: ${formatTanggal(new Date(tanggal))}`, 105, 22, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text(`Generated on: ${new Date().toLocaleString('id-ID')}`, 105, 28, { align: 'center' });
            
            // Prepare table data
            const tableData = data.map((item, index) => [
                (index + 1).toString(),
                item.id_siswa,
                item.nama_siswa,
                getStatusName(item.status),
                item.keterangan || '-'
            ]);
            
            // Add table
            doc.autoTable({
                startY: 35,
                head: [['No', 'ID Siswa', 'Nama Siswa', 'Status', 'Keterangan']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [72, 187, 120] }
            });
        }

        async function exportBulananPDF(doc) {
            const data = prepareExportDataBulanan();
            const kelas = document.getElementById('filterKelasRekap').value;
            const bulan = document.getElementById('filterBulanRekap').value;
            const tahun = document.getElementById('filterTahunRekap').value;
            
            // Add header
            doc.setFontSize(16);
            doc.setTextColor(40, 40, 40);
            doc.text('REKAP ABSENSI BULANAN', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Kelas: ${kelas} | Periode: ${getNamaBulan(bulan)} ${tahun}`, 105, 22, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text(`Generated on: ${new Date().toLocaleString('id-ID')}`, 105, 28, { align: 'center' });
            
            // Prepare table data
            const tableData = data.map(item => [
                item.nama_siswa,
                item.totalHadir.toString(),
                item.totalIzin.toString(),
                item.totalSakit.toString(),
                item.totalAlpha.toString(),
                `${item.persentaseHadir}%`
            ]);
            
            // Add table
            doc.autoTable({
                startY: 35,
                head: [['Nama Siswa', 'Hadir', 'Izin', 'Sakit', 'Alpha', 'Persentase']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [102, 126, 234] }
            });
        }

        function prepareExportDataHarian() {
            const exportData = [];
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('filterTanggal').value;
            
            currentData.siswa.forEach(siswa => {
                const absen = currentData.absensiExisting[siswa.id_siswa];
                exportData.push({
                    id_siswa: siswa.id_siswa,
                    nama_siswa: siswa.nama_siswa,
                    status: absen ? absen.status : 'H',
                    keterangan: absen ? absen.keterangan : '',
                    tanggal: tanggal,
                    kelas: kelas
                });
            });
            
            return exportData;
        }

        function prepareExportDataBulanan() {
            return currentData.rekapData || [];
        }

        function getExportTimestamp() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}${month}${day}_${hours}${minutes}`;
        }

        // ==================== END EXPORT FUNCTIONS ====================

        function updateStats() {
            const kelas = document.getElementById('filterKelas').value;
            const totalSiswa = currentData.siswa.length;
            
            if (totalSiswa === 0) {
                document.getElementById('totalSiswa').textContent = '0';
                document.getElementById('infoKelas').textContent = 'Pilih kelas';
                document.getElementById('hadirHariIni').textContent = '0';
                document.getElementById('tidakHadir').textContent = '0';
                document.getElementById('persentaseHadir').textContent = '0%';
                return;
            }
            
            // Hitung statistik
            let hadir = 0, izin = 0, sakit = 0, alpha = 0;
            
            currentData.siswa.forEach(siswa => {
                const absen = currentData.absensiExisting[siswa.id_siswa];
                if (absen) {
                    switch (absen.status) {
                        case 'H': hadir++; break;
                        case 'I': izin++; break;
                        case 'S': sakit++; break;
                        case 'A': alpha++; break;
                        default: hadir++;
                    }
                } else {
                    hadir++;
                }
            });
            
            const tidakHadir = izin + sakit + alpha;
            const persentaseHadir = totalSiswa > 0 ? Math.round((hadir / totalSiswa) * 100) : 0;
            
            document.getElementById('totalSiswa').textContent = totalSiswa;
            document.getElementById('infoKelas').textContent = `Kelas ${kelas}`;
            document.getElementById('hadirHariIni').textContent = hadir;
            document.getElementById('tidakHadir').textContent = tidakHadir;
            document.getElementById('persentaseHadir').textContent = `${persentaseHadir}%`;
        }

        function updateProgress() {
            if (!currentData.siswa || currentData.siswa.length === 0) return;
            
            const totalSiswa = currentData.siswa.length;
            let completed = 0;
            
            currentData.siswa.forEach(siswa => {
                if (currentData.absensiExisting[siswa.id_siswa]) {
                    completed++;
                }
            });
            
            const percentage = Math.round((completed / totalSiswa) * 100);
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = 
                `${completed} dari ${totalSiswa} siswa sudah diinput`;
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
        }

        function updateTableInfo() {
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('filterTanggal').value;
            
            document.getElementById('tableTitle').textContent = `Absensi Kelas ${kelas}`;
            document.getElementById('tableDescription').textContent = 
                `Tanggal: ${formatTanggal(new Date(tanggal))} - ${currentData.siswa.length} siswa`;
        }

        function resetAbsensi() {
            showConfirm(
                'Reset Form Absensi',
                'üîÑ Reset semua input absensi?\n\nSemua perubahan yang belum disimpan akan hilang.',
                'Reset',
                'Batal'
            ).then(confirmed => {
                if (confirmed) {
                    // Reset semua radio button ke Hadir
                    const radios = document.querySelectorAll('input[type="radio"]');
                    radios.forEach(radio => {
                        if (radio.value === 'H') {
                            radio.checked = true;
                        }
                    });
                    
                    // Reset semua input keterangan
                    const inputs = document.querySelectorAll('input[type="text"]');
                    inputs.forEach(input => {
                        input.value = '';
                    });
                    
                    showNotification('üîÑ Form absensi telah direset', 'info', 2000);
                }
            });
        }

        // Custom Notification System
        function showNotification(message, type = 'info', duration = 4000) {
            // Hapus notifikasi sebelumnya jika ada
            const existingNotification = document.getElementById('custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Buat element notifikasi
            const notification = document.createElement('div');
            notification.id = 'custom-notification';
            
            // Set warna berdasarkan type
            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                warning: '#ed8936',
                info: '#4299e1'
            };
            
            // Tambahkan icon berdasarkan type
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 16px;">${icons[type]}</span>
                    <span>${message}</span>
                </div>
            `;
            
            // Set styles
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '15px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                maxWidth: '400px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                animation: 'slideIn 0.3s ease',
                fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
                cursor: 'pointer',
                background: colors[type] || colors.info
            });
            
            // Tambahkan ke body
            document.body.appendChild(notification);
            
            // Click to close
            notification.addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            });
            
            // Auto-hide jika duration > 0
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
            
            return notification;
        }

        // Custom Confirm Dialog
        function showConfirm(title, message, confirmText = 'Ya', cancelText = 'Tidak') {
            return new Promise((resolve) => {
                // Hapus confirm dialog sebelumnya jika ada
                const existingConfirm = document.getElementById('custom-confirm-dialog');
                if (existingConfirm) {
                    existingConfirm.remove();
                }
                
                // Buat overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                // Buat dialog
                const dialog = document.createElement('div');
                dialog.id = 'custom-confirm-dialog';
                dialog.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    max-width: 400px;
                    width: 90%;
                    animation: fadeIn 0.3s ease;
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin: 0 0 12px 0; color: #2d3748; font-size: 18px;">${title}</h3>
                    <p style="margin: 0 0 20px 0; color: #4a5568; line-height: 1.5; white-space: pre-line;">${message}</p>
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button id="confirm-cancel" style="padding: 10px 20px; border: 1px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ${cancelText}
                        </button>
                        <button id="confirm-ok" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ${confirmText}
                        </button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Event listeners
                document.getElementById('confirm-ok').addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                document.getElementById('confirm-cancel').addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                });
                
                // Tambahkan CSS animations
                if (!document.getElementById('confirm-styles')) {
                    const style = document.createElement('style');
                    style.id = 'confirm-styles';
                    style.textContent = `
                        @keyframes fadeIn {
                            from { opacity: 0; transform: scale(0.9); }
                            to { opacity: 1; transform: scale(1); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            });
        }

        // Utility functions
        function formatTanggal(date) {
            return date.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTanggalShort(date) {
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short'
            });
        }

        function getNamaBulan(bulan) {
            const bulanNames = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ];
            return bulanNames[parseInt(bulan) - 1] || '';
        }

        function getStatusName(status) {
            const statusItem = STATUS_KEHADIRAN.find(s => s.id === status);
            return statusItem ? statusItem.nama : 'Tidak Diketahui';
        }

        function logout() {
            console.log('üö™ Logging out...');
            localStorage.removeItem('user');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '../index.html';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Absensi page loaded');
            
            document.getElementById('filterTanggal').addEventListener('change', function() {
                const kelas = document.getElementById('filterKelas').value;
                if (kelas) {
                    loadAbsensiHariIni();
                }
            });
            
            document.getElementById('filterKelas').addEventListener('change', function() {
                const tanggal = document.getElementById('filterTanggal').value;
                if (tanggal) {
                    loadAbsensiHariIni();
                }
            });
            
            document.getElementById('filterPeriode').addEventListener('change', function() {
                const periode = this.value;
                if (periode !== 'custom') {
                    const tanggal = getTanggalByPeriode(periode);
                    document.getElementById('filterTanggal').value = tanggal;
                    
                    const kelas = document.getElementById('filterKelas').value;
                    if (kelas) {
                        loadAbsensiHariIni();
                    }
                }
            });
            
            loadAbsensi();
        });

        console.log('‚úÖ Absensi JavaScript loaded successfully');
    </script>
</body>
</html>